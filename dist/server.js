/*! For license information please see server.js.LICENSE.txt */
(()=>{var e={0:(e,r,t)=>{var n=t(252).Router(),o=t(833),a=o.getPendingProperties,i=o.approveProperty,s=o.rejectProperty,c=o.getApprovalStats,u=t(226).auth,l=t(902).checkPermission,p=t(567),d=p.validatePropertyId,f=p.validateRejection;n.get("/pending",u,l("properties","Read"),a),n.get("/stats",u,l("properties","Approve"),c),n.patch("/:id/approve",u,l("properties","Approve"),d,i),n.patch("/:id/reject",u,l("properties","Approve"),d,f,s),e.exports=n},11:e=>{e.exports={validateImageUrl:function(e){return!(!e||"string"!=typeof e)&&(/^https?:\/\/.+(\.(jpg|jpeg|png|webp)|\/[^\/]+)$/i.test(e)||/^https?:\/\/localhost:\d+\/uploads\/.+\.(jpg|jpeg|png|webp)$/i.test(e)||/^https?:\/\/[^\/]+\/uploads\/.+\.(jpg|jpeg|png|webp)$/i.test(e))}}},37:e=>{"use strict";e.exports=require("mongoose")},62:(e,r,t)=>{function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function o(){var e,r,t="function"==typeof Symbol?Symbol:{},n=t.iterator||"@@iterator",i=t.toStringTag||"@@toStringTag";function s(t,n,o,i){var s=n&&n.prototype instanceof u?n:u,l=Object.create(s.prototype);return a(l,"_invoke",function(t,n,o){var a,i,s,u=0,l=o||[],p=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(r,t){return a=r,i=0,s=e,d.n=t,c}};function f(t,n){for(i=t,s=n,r=0;!p&&u&&!o&&r<l.length;r++){var o,a=l[r],f=d.p,m=a[2];t>3?(o=m===n)&&(s=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=t<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=t<3||a[0]>n||n>m)&&(a[4]=t,a[5]=n,d.n=m,i=0))}if(o||t>1)return c;throw p=!0,n}return function(o,l,m){if(u>1)throw TypeError("Generator is already running");for(p&&1===l&&f(l,m),i=l,s=m;(r=i<2?e:s)||!p;){a||(i?i<3?(i>1&&(d.n=-1),f(i,s)):d.n=s:d.v=s);try{if(u=2,a){if(i||(o="next"),r=a[o]){if(!(r=r.call(a,s)))throw TypeError("iterator result is not an object");if(!r.done)return r;s=r.value,i<2&&(i=0)}else 1===i&&(r=a.return)&&r.call(a),i<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((r=(p=d.n<0)?s:t.call(n,d))!==c)break}catch(r){a=e,i=1,s=r}finally{u=1}}return{value:r,done:p}}}(t,o,i),!0),l}var c={};function u(){}function l(){}function p(){}r=Object.getPrototypeOf;var d=[][n]?r(r([][n]())):(a(r={},n,function(){return this}),r),f=p.prototype=u.prototype=Object.create(d);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,a(e,i,"GeneratorFunction")),e.prototype=Object.create(f),e}return l.prototype=p,a(f,"constructor",p),a(p,"constructor",l),l.displayName="GeneratorFunction",a(p,i,"GeneratorFunction"),a(f),a(f,i,"Generator"),a(f,n,function(){return this}),a(f,"toString",function(){return"[object Generator]"}),(o=function(){return{w:s,m}})()}function a(e,r,t,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}a=function(e,r,t,n){function i(r,t){a(e,r,function(e){return this._invoke(r,t,e)})}r?o?o(e,r,{value:t,enumerable:!n,configurable:!n,writable:!n}):e[r]=t:(i("next",0),i("throw",1),i("return",2))},a(e,r,t,n)}function i(e,r,t,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void t(e)}s.done?r(c):Promise.resolve(c).then(n,o)}function s(e){return function(){var r=this,t=arguments;return new Promise(function(n,o){var a=e.apply(r,t);function s(e){i(a,n,o,s,c,"next",e)}function c(e){i(a,n,o,s,c,"throw",e)}s(void 0)})}}function c(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,u(n.key),n)}}function u(e){var r=function(e){if("object"!=n(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var t=r.call(e,"string");if("object"!=n(t))return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==n(r)?r:r+""}var l=t(461),p=t(928),d=t(896).promises,f=t(245),m=f.processImage,y=f.validateImage,g=f.getImageMetadata,h=function(){return e=function e(r){!function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this,e);var t=p.join(__dirname,"uploads");this.destination=r.destination||t,this.folderName=r.folderName||"",this.baseUrl=r.baseUrl||(process.env.BASE_URL?"".concat(process.env.BASE_URL,"/uploads"):"http://localhost:8000/uploads")},r=[{key:"_ensureDirectoryExists",value:(t=s(o().m(function e(r){return o().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,d.access(r);case 1:e.n=3;break;case 2:return e.p=2,e.v,e.n=3,d.mkdir(r,{recursive:!0});case 3:return e.a(2)}},e,null,[[0,2]])})),function(e){return t.apply(this,arguments)})},{key:"_predictOptimalQuality",value:function(e,r,t,n){var o=n/e,a=r*t/1048576;if(o<.1)return 1;if(a>20){var i=Math.max(1,Math.round(100*o*.3));return console.log("🖼️ Very high resolution (".concat(Math.round(10*a)/10,"MP) → Quality ").concat(i,"%")),i}if(a>10){var s=Math.max(1,Math.round(100*o*.5));return console.log("📸 High resolution (".concat(Math.round(10*a)/10,"MP) → Quality ").concat(s,"%")),s}if(e>5242880){var c=Math.max(1,Math.round(100*o*.6));return console.log("📦 Very large file (".concat(Math.round(e/1048576*10)/10,"MB) → Quality ").concat(c,"%")),c}return Math.max(1,Math.round(100*o*.8))}},{key:"_handleFile",value:function(e,r,t){var n=this,a=[];r.stream.on("data",function(e){a.push(e)}),r.stream.on("end",s(o().m(function e(){var i,s,c,u,l,f,h,v,b,w,E,S,j,P,A,k,I,O,T,x,q,_,R,M;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,i=Buffer.concat(a),s=i.length,c=Math.round(s/1024),console.log("📊 Original size: ".concat(s," bytes (").concat(c,"KB)")),e.n=1,y(i);case 1:return e.n=2,g(i);case 2:return u=e.v,console.log("📐 Original dimensions: ".concat(u.width,"x").concat(u.height)),l=Date.now(),f=r.originalname.split(".")[0].replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_-]/g,""),h=n.folderName?p.join(n.destination,n.folderName):n.destination,e.n=3,n._ensureDirectoryExists(h);case 3:if(E=!1,S=100,!(s>(v=102400))){e.n=10;break}return console.log("🎯 Starting hybrid compression: target ≤".concat(100,"KB")),j=0,P=n._predictOptimalQuality(s,u.width,u.height,v),j++,e.n=4,m(i,{quality:P,originalMetadata:u});case 4:b=e.v,w=b.length,S=P;case 5:if(!(w>v&&S>1&&j<2)){e.n=9;break}if(A=Math.abs(w-v)/v,console.log("🔧 Size ".concat(Math.round(w/1024),"KB > target 100KB (deviation: ").concat(Math.round(100*A),"%), continuing compression...")),k=v/w,I=void 0,(I=1===j?Math.max(1,Math.min(95,Math.round(S*Math.pow(k,.5)))):Math.max(1,Math.round(S*k*.8)))>=S&&(I=Math.max(1,S-5)),I===S){e.n=7;break}return j++,console.log("🎯 Attempt ".concat(j,": Trying quality ").concat(I,"%...")),e.n=6,m(i,{quality:I,originalMetadata:u});case 6:b=e.v,w=b.length,S=I,console.log("🎯 Attempt ".concat(j,": Quality ").concat(I,"% → ").concat(Math.round(w/1024),"KB")),e.n=8;break;case 7:return e.a(3,9);case 8:e.n=5;break;case 9:E=!0,console.log("✅ Hybrid compression complete: ".concat(s," → ").concat(w," bytes (").concat(Math.round(100*(1-w/s)),"% reduction) in ").concat(j," attempts")),w>v?1===S?console.log("⚠️ Final size ".concat(Math.round(w/1024),"KB still exceeds target even at 1% quality (minimum). Dimensions preserved at ").concat(u.width,"x").concat(u.height,". This is the absolute minimum achievable without resizing.")):console.log("⚠️ Final size ".concat(Math.round(w/1024),"KB still exceeds target. Stopped at ").concat(S,"% quality after ").concat(j," attempts. Dimensions preserved at ").concat(u.width,"x").concat(u.height,".")):console.log("🎉 Target achieved! Final size ".concat(Math.round(w/1024),"KB ≤ 100KB at ").concat(S,"% quality.")),e.n=12;break;case 10:return console.log("✅ File ≤ 100KB, uploading as-is (converting to WebP only)"),e.n=11,m(i,{quality:100,originalMetadata:u});case 11:b=e.v,w=b.length,S=100,console.log("✅ WebP conversion: ".concat(s," → ").concat(w," bytes (").concat(Math.round(100*(1-w/s)),"% reduction)"));case 12:return O="property_".concat(l,"_").concat(f,".webp"),T=p.join(h,O),x=n.folderName?p.join(n.folderName,O).replace(/\\/g,"/"):O,e.n=13,d.writeFile(T,b);case 13:q="".concat(n.baseUrl,"/").concat(x),_=Math.round(100*(1-w/s)),R={destination:h,filename:O,path:T,location:q,originalname:r.originalname,mimetype:"image/webp",size:w,originalSize:s,compressionRatio:_,compressionApplied:E,quality:S,width:u.width,height:u.height,format:"webp",compressed:E,processedImages:{url:q,filename:O,path:T,size:w,dimensions:"".concat(u.width,"x").concat(u.height),relativePath:x},key:x.replace(/\.[^/.]+$/,"")},t(null,R),e.n=15;break;case 14:e.p=14,M=e.v,console.error("❌ Error processing/saving image:",M),t(M);case 15:return e.a(2)}},e,null,[[0,14]])}))),r.stream.on("error",function(e){console.error("❌ Stream error:",e),t(e)})}},{key:"_removeFile",value:function(e,r,t){r.path?d.unlink(r.path).then(function(){t(null)}).catch(function(e){console.error("❌ Error deleting file: ".concat(r.path),e),t(e)}):t(null)}}],r&&c(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,r,t}(),v=l({storage:new h({folderName:"",baseUrl:process.env.BASE_URL?"".concat(process.env.BASE_URL,"/uploads"):"http://localhost:8000/uploads"}),limits:{fileSize:11534336,files:10},fileFilter:function(e,r,t){console.log("🔍 Smart compression fileFilter called for file:",r.originalname,"mimetype:",r.mimetype),r.mimetype.startsWith("image/")?t(null,!0):t(new Error("Only image files are allowed!"),!1)}}),b=v;e.exports={uploadPropertyImages:b,uploadSmartCompressedImages:v,SmartCompressionStorage:h}},110:(e,r,t)=>{function n(){var e,r,t="function"==typeof Symbol?Symbol:{},a=t.iterator||"@@iterator",i=t.toStringTag||"@@toStringTag";function s(t,n,a,i){var s=n&&n.prototype instanceof u?n:u,l=Object.create(s.prototype);return o(l,"_invoke",function(t,n,o){var a,i,s,u=0,l=o||[],p=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(r,t){return a=r,i=0,s=e,d.n=t,c}};function f(t,n){for(i=t,s=n,r=0;!p&&u&&!o&&r<l.length;r++){var o,a=l[r],f=d.p,m=a[2];t>3?(o=m===n)&&(s=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=t<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=t<3||a[0]>n||n>m)&&(a[4]=t,a[5]=n,d.n=m,i=0))}if(o||t>1)return c;throw p=!0,n}return function(o,l,m){if(u>1)throw TypeError("Generator is already running");for(p&&1===l&&f(l,m),i=l,s=m;(r=i<2?e:s)||!p;){a||(i?i<3?(i>1&&(d.n=-1),f(i,s)):d.n=s:d.v=s);try{if(u=2,a){if(i||(o="next"),r=a[o]){if(!(r=r.call(a,s)))throw TypeError("iterator result is not an object");if(!r.done)return r;s=r.value,i<2&&(i=0)}else 1===i&&(r=a.return)&&r.call(a),i<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((r=(p=d.n<0)?s:t.call(n,d))!==c)break}catch(r){a=e,i=1,s=r}finally{u=1}}return{value:r,done:p}}}(t,a,i),!0),l}var c={};function u(){}function l(){}function p(){}r=Object.getPrototypeOf;var d=[][a]?r(r([][a]())):(o(r={},a,function(){return this}),r),f=p.prototype=u.prototype=Object.create(d);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,o(e,i,"GeneratorFunction")),e.prototype=Object.create(f),e}return l.prototype=p,o(f,"constructor",p),o(p,"constructor",l),l.displayName="GeneratorFunction",o(p,i,"GeneratorFunction"),o(f),o(f,i,"Generator"),o(f,a,function(){return this}),o(f,"toString",function(){return"[object Generator]"}),(n=function(){return{w:s,m}})()}function o(e,r,t,n){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}o=function(e,r,t,n){function i(r,t){o(e,r,function(e){return this._invoke(r,t,e)})}r?a?a(e,r,{value:t,enumerable:!n,configurable:!n,writable:!n}):e[r]=t:(i("next",0),i("throw",1),i("return",2))},o(e,r,t,n)}function a(e,r,t,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void t(e)}s.done?r(c):Promise.resolve(c).then(n,o)}var i=t(62),s=i.uploadPropertyImages,c=i.uploadSmartCompressedImages,u=t(461),l=u({storage:u.memoryStorage(),limits:{fileSize:11534336,files:10},fileFilter:function(e,r,t){r.mimetype.startsWith("image/")?t(null,!0):t(new Error("Only image files are allowed!"),!1)}}),p=function(){var e,r=(e=n().m(function e(r,o,a){var i,s,c,u,l,p,d,f,m,y,g,h,v,b,w,E,S,j,P,A,k,I,O,T,x;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:if(r.pendingImages&&0!==r.pendingImages.length){e.n=1;break}return console.log("📋 No images to process"),e.a(2,a());case 1:return e.p=1,console.log("🔄 Processing ".concat(r.pendingImages.length," validated image(s)...")),i=t(245),s=i.processImage,c=i.validateImage,u=i.getImageMetadata,l=t(928),p=t(896).promises,d=l.join(__dirname,"../uploads"),e.n=2,p.mkdir(d,{recursive:!0});case 2:f=[],m=0;case 3:if(!(m<r.pendingImages.length)){e.n=12;break}return y=r.pendingImages[m],e.p=4,e.n=5,c(y.buffer,y.originalname);case 5:return e.n=6,u(y.buffer);case 6:return h=e.v,v=Date.now(),b=Math.random().toString(36).substring(2,15),w="".concat(v,"-").concat(b,".webp"),E=l.join(d,w),e.n=7,s(y.buffer,{quality:85,format:"webp"});case 7:return S=e.v,e.n=8,p.writeFile(E,S);case 8:return e.n=9,p.stat(E);case 9:j=e.v,P={size:j.size,compressed:!0,quality:85,width:h.width,height:h.height},A=r.imageMetadata&&r.imageMetadata[m]?r.imageMetadata[m]:{},k=process.env.BASE_URL||"http://localhost:8000",I="".concat(k,"/uploads/").concat(w),O={url:I,publicId:w,originalName:y.originalname,size:P.size,originalSize:y.size,compressionRatio:Math.round((y.size-P.size)/y.size*100),format:"webp",width:P.width,height:P.height,compressed:P.compressed||!1,quality:P.quality||85,compressionApplied:P.compressed||!1,altText:A.altText||"Property image ".concat(m+1),order:void 0!==A.order?parseInt(A.order):m,isMain:"true"===A.isMain||!0===A.isMain||0===m&&!(null!==(g=r.imageMetadata)&&void 0!==g&&g.some(function(e){return"true"===e.isMain||!0===e.isMain}))},f.push(O),console.log("✅ Processed image ".concat(m+1,": ").concat(y.originalname," → ").concat(w)),e.n=11;break;case 10:return e.p=10,T=e.v,console.error("❌ Failed to process image ".concat(m+1,":"),T),e.a(2,o.status(400).json({success:!1,error:'Failed to process image "'.concat(y.originalname,'": ').concat(T.message)}));case 11:m++,e.n=3;break;case 12:r.uploadedImages=f,r.files=f.map(function(e){return{location:e.url,key:e.publicId,originalname:e.originalName,size:e.size,originalSize:e.originalSize,compressionRatio:e.compressionRatio,format:e.format,width:e.width,height:e.height,compressed:e.compressed,quality:e.quality,compressionApplied:e.compressionApplied}}),f.forEach(function(e,r){var t=e.compressionApplied?"COMPRESSED":"AS-IS";console.log("📊 Image ".concat(r+1," [").concat(t,"]: ").concat(e.originalSize," → ").concat(e.size," bytes (").concat(e.compressionRatio,"% reduction, quality: ").concat(e.quality,"%)"))}),delete r.pendingImages,a(),e.n=14;break;case 13:return e.p=13,x=e.v,console.error("❌ Image processing error:",x),e.a(2,o.status(500).json({success:!1,error:"Image processing failed. Please try again."}));case 14:return e.a(2)}},e,null,[[4,10],[1,13]])}),function(){var r=this,t=arguments;return new Promise(function(n,o){var i=e.apply(r,t);function s(e){a(i,n,o,s,c,"next",e)}function c(e){a(i,n,o,s,c,"throw",e)}s(void 0)})});return function(e,t,n){return r.apply(this,arguments)}}();e.exports={handlePropertyImageUpload:function(e,r,t){s.array("images",10)(e,r,function(n){if(n)return console.error("Image upload error:",n),"LIMIT_FILE_SIZE"===n.code?r.status(400).json({success:!1,error:"File too large. Maximum size is 11MB per image."}):"LIMIT_FILE_COUNT"===n.code?r.status(400).json({success:!1,error:"Too many files. Maximum 10 images allowed per property."}):"Only image files are allowed!"===n.message?r.status(400).json({success:!1,error:"Only image files (JPG, JPEG, PNG, WebP) are allowed."}):r.status(500).json({success:!1,error:"Image upload failed. Please try again."});e.files&&e.files.length>0&&(e.uploadedImages=e.files.map(function(e){return{url:e.location,publicId:e.key,originalName:e.originalname,size:e.size,originalSize:e.originalSize,compressionRatio:e.compressionRatio,format:"webp",width:e.width,height:e.height,compressed:e.compressionApplied,quality:e.quality,compressionApplied:e.compressionApplied,processedImages:e.processedImages||null}}),e.uploadedImages.forEach(function(e,r){var t=e.compressionApplied?"COMPRESSED":"AS-IS";console.log("📊 Image ".concat(r+1," [").concat(t,"]: ").concat(e.originalSize," → ").concat(e.size," bytes (").concat(e.compressionRatio,"% reduction, quality: ").concat(e.quality,"%)"))})),t()})},handleSmartCompressedImageUpload:function(e,r,t){c.array("images",10)(e,r,function(n){if(n)return console.error("Smart compression upload error:",n),"LIMIT_FILE_SIZE"===n.code?r.status(400).json({success:!1,error:"File too large. Maximum size is 11MB per image."}):"LIMIT_FILE_COUNT"===n.code?r.status(400).json({success:!1,error:"Too many files. Maximum 10 images allowed per upload."}):"Only image files are allowed!"===n.message?r.status(400).json({success:!1,error:"Only image files (JPG, JPEG, PNG, WebP) are allowed."}):r.status(500).json({success:!1,error:"Smart compression upload failed. Please try again."});e.files&&e.files.length>0&&(e.uploadedImages=e.files.map(function(e){return{url:e.location,publicId:e.key,originalName:e.originalname,size:e.size,originalSize:e.originalSize,compressionRatio:e.compressionRatio,format:"webp",width:e.width,height:e.height,compressed:e.compressionApplied,quality:e.quality,compressionApplied:e.compressionApplied,processedImages:e.processedImages||null}}),e.uploadedImages.forEach(function(e,r){var t=e.compressionApplied?"COMPRESSED":"AS-IS";console.log("📊 Image ".concat(r+1," [").concat(t,"]: ").concat(e.originalSize," → ").concat(e.size," bytes (").concat(e.compressionRatio,"% reduction, quality: ").concat(e.quality,"%)"))})),t()})},optionalImages:function(e,r,t){t()},parseMultipartData:function(e,r,t){l.array("images",10)(e,r,function(n){if(n)return console.error("Form data parsing error:",n),"LIMIT_FILE_SIZE"===n.code?r.status(400).json({success:!1,error:"File too large. Maximum size is 11MB per image."}):"LIMIT_FILE_COUNT"===n.code?r.status(400).json({success:!1,error:"Too many files. Maximum 10 images allowed per property."}):"Only image files are allowed!"===n.message?r.status(400).json({success:!1,error:"Only image files (JPG, JPEG, PNG, WebP) are allowed."}):r.status(500).json({success:!1,error:"Form data parsing failed. Please try again."});e.files&&e.files.length>0&&(e.pendingImages=e.files,console.log("📋 Parsed ".concat(e.files.length," image(s) in memory (not saved yet)"))),t()})},processValidatedImages:p}},174:e=>{"use strict";e.exports=require("compression")},187:(e,r,t)=>{var n=t(37),o=t(989),a=o.EMIRATES,i=o.LISTING_TYPES,s=o.PROPERTY_STATUS,c=o.APPROVAL_STATUS,u=o.AREA_UNITS,l=o.PARKING_TYPES,p=o.PRICE_TYPES,d=o.COUNTRIES,f=o.CURRENCIES,m=t(591),y=new n.Schema({url:{type:String,required:!0},publicId:{type:String,required:!0},altText:{type:String,default:""},order:{type:Number,default:0},isMain:{type:Boolean,default:!1},originalName:String,size:Number,format:String},{_id:!0}),g=new n.Schema({address:{type:String,required:!0},emirate:{type:String,required:!0,enum:a},area:{type:String,required:!0,enum:[]},country:{type:String,default:d[0],enum:d},neighborhood:{type:String,trim:!0}},{_id:!1}),h=new n.Schema({bedrooms:{type:Number},bathrooms:{type:Number},area:{type:Number},areaUnit:{type:String,enum:u,default:u[0]},floorLevel:{type:String,trim:!0},totalFloors:{type:Number},landArea:{type:Number},yearBuilt:{type:Number},parking:{available:{type:Boolean,default:!1},type:{type:String,enum:l},spaces:{type:Number,default:0}}},{_id:!1}),v=new n.Schema({title:{type:String,required:!0},slug:{type:String,unique:!0,lowercase:!0,required:!1},description:{type:String,required:!0},propertyType:{type:String,required:!0},price:{type:Number,required:function(){return"off plan"!==this.listingType}},currency:{type:String,default:f[0],enum:f},priceType:{type:String,enum:p,default:p[0]},location:{type:g,required:!0},details:{type:h,required:!0},amenities:{type:[String],default:[]},images:{type:[y],required:!0},featured:{type:Boolean,default:!1},status:{type:String,enum:s,default:s[0]},previousStatus:{type:String,enum:s,required:!1},listingType:{type:String,enum:i,required:!0},createdBy:{type:n.Schema.Types.ObjectId,ref:"User",required:!0},createdAt:{type:Date,default:Date.now},updatedBy:{type:n.Schema.Types.ObjectId,ref:"User"},updatedAt:{type:Date},approvalStatus:{type:String,enum:c,default:"not_applicable"},approvedBy:{type:n.Schema.Types.ObjectId,ref:"User"},approvedAt:{type:Date},rejectionReason:{type:String,trim:!0,maxlength:500}},{timestamps:!1});v.index({slug:1}),v.index({status:1,listingType:1}),v.index({propertyType:1}),v.index({price:1}),v.index({"location.emirate":1}),v.index({"location.area":1}),v.index({"details.bedrooms":1}),v.index({"details.area":1}),v.index({featured:1}),v.index({createdAt:-1}),v.index({approvalStatus:1}),v.index({createdBy:1,approvalStatus:1}),v.index({title:"text",description:"text","location.address":"text","location.emirate":"text","location.area":"text","location.neighborhood":"text"}),v.pre("save",function(e){if((this.isModified("title")||this.isNew||!this.slug)&&(this.slug=m(this.title,{lower:!0,strict:!0,remove:/[*+~.()'"!:@]/g})),!this.slug)return e(new Error("Failed to generate slug"));e()}),v.pre("save",function(e){if(this.images&&this.images.length>0){var r=this.images.filter(function(e){return e.isMain});0===r.length?this.images[0].isMain=!0:r.length>1&&this.images.forEach(function(e,r){e.isMain=0===r})}e()}),v.pre("save",function(e){this.isNew?(this.updatedAt=void 0,this.updatedBy=void 0):this.updatedAt||(this.updatedAt=new Date),e()}),e.exports=n.model("Property",v)},217:(e,r,t)=>{function n(){var e,r,t="function"==typeof Symbol?Symbol:{},a=t.iterator||"@@iterator",i=t.toStringTag||"@@toStringTag";function s(t,n,a,i){var s=n&&n.prototype instanceof u?n:u,l=Object.create(s.prototype);return o(l,"_invoke",function(t,n,o){var a,i,s,u=0,l=o||[],p=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(r,t){return a=r,i=0,s=e,d.n=t,c}};function f(t,n){for(i=t,s=n,r=0;!p&&u&&!o&&r<l.length;r++){var o,a=l[r],f=d.p,m=a[2];t>3?(o=m===n)&&(s=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=t<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=t<3||a[0]>n||n>m)&&(a[4]=t,a[5]=n,d.n=m,i=0))}if(o||t>1)return c;throw p=!0,n}return function(o,l,m){if(u>1)throw TypeError("Generator is already running");for(p&&1===l&&f(l,m),i=l,s=m;(r=i<2?e:s)||!p;){a||(i?i<3?(i>1&&(d.n=-1),f(i,s)):d.n=s:d.v=s);try{if(u=2,a){if(i||(o="next"),r=a[o]){if(!(r=r.call(a,s)))throw TypeError("iterator result is not an object");if(!r.done)return r;s=r.value,i<2&&(i=0)}else 1===i&&(r=a.return)&&r.call(a),i<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((r=(p=d.n<0)?s:t.call(n,d))!==c)break}catch(r){a=e,i=1,s=r}finally{u=1}}return{value:r,done:p}}}(t,a,i),!0),l}var c={};function u(){}function l(){}function p(){}r=Object.getPrototypeOf;var d=[][a]?r(r([][a]())):(o(r={},a,function(){return this}),r),f=p.prototype=u.prototype=Object.create(d);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,o(e,i,"GeneratorFunction")),e.prototype=Object.create(f),e}return l.prototype=p,o(f,"constructor",p),o(p,"constructor",l),l.displayName="GeneratorFunction",o(p,i,"GeneratorFunction"),o(f),o(f,i,"Generator"),o(f,a,function(){return this}),o(f,"toString",function(){return"[object Generator]"}),(n=function(){return{w:s,m}})()}function o(e,r,t,n){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}o=function(e,r,t,n){function i(r,t){o(e,r,function(e){return this._invoke(r,t,e)})}r?a?a(e,r,{value:t,enumerable:!n,configurable:!n,writable:!n}):e[r]=t:(i("next",0),i("throw",1),i("return",2))},o(e,r,t,n)}function a(e,r,t,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void t(e)}s.done?r(c):Promise.resolve(c).then(n,o)}function i(e){return function(){var r=this,t=arguments;return new Promise(function(n,o){var i=e.apply(r,t);function s(e){a(i,n,o,s,c,"next",e)}function c(e){a(i,n,o,s,c,"throw",e)}s(void 0)})}}var s=t(37),c=t(729),u=t(829),l=new s.Schema({username:{type:String,required:!0,unique:!0},password:{type:String,required:!0,select:!1},name:{type:String,required:[!0,"Name is required"],trim:!0,maxlength:[50,"Name cannot exceed 50 characters"]},email:{type:String,required:[!0,"Email is required"],unique:!0,lowercase:!0,match:[/^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/,"Please enter a valid email"]},role:{type:String,enum:["SuperAdmin","admin"],default:"admin"},isActive:{type:Boolean,default:!0},lastLogin:{type:Date,default:null},loginAttempts:{type:Number,default:0},lockUntil:{type:Date,default:null},createdBy:{type:s.Schema.Types.ObjectId,ref:"User",default:null},updatedBy:{type:s.Schema.Types.ObjectId,ref:"User",default:null}},{timestamps:!0});l.index({username:1}),l.index({email:1}),l.pre("save",function(){var e=i(n().m(function e(r){var t,o;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:if(this.isModified("password")){e.n=1;break}return e.a(2,r());case 1:return e.p=1,e.n=2,c.genSalt(parseInt(process.env.BCRYPT_ROUNDS));case 2:return t=e.v,e.n=3,c.hash(this.password,t);case 3:this.password=e.v,r(),e.n=5;break;case 4:e.p=4,o=e.v,r(o);case 5:return e.a(2)}},e,this,[[1,4]])}));return function(r){return e.apply(this,arguments)}}()),l.methods.comparePassword=function(){var e=i(n().m(function e(r){return n().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,c.compare(r,this.password);case 1:return e.a(2,e.v)}},e,this)}));return function(r){return e.apply(this,arguments)}}(),l.methods.generateAuthToken=function(){var e=process.env.JWT_EXPIRE;if(console.log("JWT_EXPIRE value:",e),!e)throw new Error("JWT_EXPIRE environment variable is not set. Please configure it in your deployment environment.");return u.sign({id:this._id,username:this.username,email:this.email,role:this.role},process.env.JWT_SECRET,{expiresIn:e})},l.methods.updateLastLogin=function(){return this.lastLogin=new Date,this.loginAttempts=0,this.lockUntil=null,this.save()},l.methods.incrementLoginAttempts=function(){var e=parseInt(process.env.MAX_LOGIN_ATTEMPTS),r=60*parseInt(process.env.ACCOUNT_LOCK_TIME)*1e3;return this.loginAttempts+=1,this.loginAttempts>=e&&(this.lockUntil=new Date(Date.now()+r)),this.save()},l.methods.isLocked=function(){return this.lockUntil&&this.lockUntil>new Date},l.methods.toJSON=function(){var e=this.toObject();return delete e.password,delete e.loginAttempts,delete e.lockUntil,delete e.__v,e},e.exports=s.model("User",l)},224:(e,r,t)=>{var n=t(252).Router(),o=t(392),a=o.getUsers,i=o.getUser,s=o.createUser,c=o.updateUser,u=o.updateUserStatus,l=o.deleteUser,p=o.getUserStats,d=o.transferPropertyOwnership,f=t(226).auth,m=t(902).checkPermission,y=t(567),g=y.createUserValidation,h=y.updateUserValidation,v=y.updateUserStatusValidation,b=y.userQueryValidation,w=y.singleUserValidation;n.get("/stats",f,m("users","Read"),p),n.route("/").get(f,m("users","Read"),b,a).post(f,m("users","Create"),g,s),n.route("/:id").get(f,m("users","Read"),w,i).put(f,m("users","Update"),h,c).delete(f,m("users","Delete"),w,l),n.patch("/:id/status",f,m("users","UpdateStatus"),v,u),n.patch("/:id/transfer-properties",f,m("users","Update"),w,d),e.exports=n},226:(e,r,t)=>{function n(){var e,r,t="function"==typeof Symbol?Symbol:{},a=t.iterator||"@@iterator",i=t.toStringTag||"@@toStringTag";function s(t,n,a,i){var s=n&&n.prototype instanceof u?n:u,l=Object.create(s.prototype);return o(l,"_invoke",function(t,n,o){var a,i,s,u=0,l=o||[],p=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(r,t){return a=r,i=0,s=e,d.n=t,c}};function f(t,n){for(i=t,s=n,r=0;!p&&u&&!o&&r<l.length;r++){var o,a=l[r],f=d.p,m=a[2];t>3?(o=m===n)&&(s=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=t<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=t<3||a[0]>n||n>m)&&(a[4]=t,a[5]=n,d.n=m,i=0))}if(o||t>1)return c;throw p=!0,n}return function(o,l,m){if(u>1)throw TypeError("Generator is already running");for(p&&1===l&&f(l,m),i=l,s=m;(r=i<2?e:s)||!p;){a||(i?i<3?(i>1&&(d.n=-1),f(i,s)):d.n=s:d.v=s);try{if(u=2,a){if(i||(o="next"),r=a[o]){if(!(r=r.call(a,s)))throw TypeError("iterator result is not an object");if(!r.done)return r;s=r.value,i<2&&(i=0)}else 1===i&&(r=a.return)&&r.call(a),i<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((r=(p=d.n<0)?s:t.call(n,d))!==c)break}catch(r){a=e,i=1,s=r}finally{u=1}}return{value:r,done:p}}}(t,a,i),!0),l}var c={};function u(){}function l(){}function p(){}r=Object.getPrototypeOf;var d=[][a]?r(r([][a]())):(o(r={},a,function(){return this}),r),f=p.prototype=u.prototype=Object.create(d);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,o(e,i,"GeneratorFunction")),e.prototype=Object.create(f),e}return l.prototype=p,o(f,"constructor",p),o(p,"constructor",l),l.displayName="GeneratorFunction",o(p,i,"GeneratorFunction"),o(f),o(f,i,"Generator"),o(f,a,function(){return this}),o(f,"toString",function(){return"[object Generator]"}),(n=function(){return{w:s,m}})()}function o(e,r,t,n){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}o=function(e,r,t,n){function i(r,t){o(e,r,function(e){return this._invoke(r,t,e)})}r?a?a(e,r,{value:t,enumerable:!n,configurable:!n,writable:!n}):e[r]=t:(i("next",0),i("throw",1),i("return",2))},o(e,r,t,n)}function a(e,r,t,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void t(e)}s.done?r(c):Promise.resolve(c).then(n,o)}function i(e){return function(){var r=this,t=arguments;return new Promise(function(n,o){var i=e.apply(r,t);function s(e){a(i,n,o,s,c,"next",e)}function c(e){a(i,n,o,s,c,"throw",e)}s(void 0)})}}var s=t(829),c=t(217),u=function(){var e=i(n().m(function e(r,t,o){var a,i,u,l,p;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,(a=r.header("Authorization"))&&a.startsWith("Bearer ")){e.n=1;break}return e.a(2,t.status(401).json({success:!1,error:"Access denied. No valid token provided."}));case 1:if(i=a.substring(7)){e.n=2;break}return e.a(2,t.status(401).json({success:!1,error:"Access denied. No token provided."}));case 2:return u=s.verify(i,process.env.JWT_SECRET),e.n=3,c.findById(u.id);case 3:if(l=e.v){e.n=4;break}return e.a(2,t.status(401).json({success:!1,error:"Invalid token. User not found."}));case 4:r.user={_id:l._id,id:l._id,username:l.username,name:l.name,email:l.email,role:l.role},r.userRole=l.role,o(),e.n=8;break;case 5:if(e.p=5,p=e.v,console.error("Auth middleware error:",p),"JsonWebTokenError"!==p.name){e.n=6;break}return e.a(2,t.status(401).json({success:!1,error:"Invalid token."}));case 6:if("TokenExpiredError"!==p.name){e.n=7;break}return e.a(2,t.status(401).json({success:!1,error:"Token expired."}));case 7:t.status(500).json({success:!1,error:"Authentication failed."});case 8:return e.a(2)}},e,null,[[0,5]])}));return function(r,t,n){return e.apply(this,arguments)}}(),l=function(){var e=i(n().m(function e(r,t,o){var a,i,u,l,p;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,(a=r.header("Authorization"))&&a.startsWith("Bearer ")){e.n=1;break}return e.a(2,t.status(401).json({success:!1,error:"Access denied. No valid token provided."}));case 1:if(i=a.substring(7)){e.n=2;break}return e.a(2,t.status(401).json({success:!1,error:"Access denied. No token provided."}));case 2:return u=s.verify(i,process.env.JWT_SECRET),e.n=3,c.findById(u.id).select("+password");case 3:if(l=e.v){e.n=4;break}return e.a(2,t.status(401).json({success:!1,error:"Invalid token. User not found."}));case 4:r.userDocument=l,o(),e.n=8;break;case 5:if(e.p=5,p=e.v,console.error("Auth with password middleware error:",p),"JsonWebTokenError"!==p.name){e.n=6;break}return e.a(2,t.status(401).json({success:!1,error:"Invalid token."}));case 6:if("TokenExpiredError"!==p.name){e.n=7;break}return e.a(2,t.status(401).json({success:!1,error:"Token expired."}));case 7:t.status(500).json({success:!1,error:"Authentication failed."});case 8:return e.a(2)}},e,null,[[0,5]])}));return function(r,t,n){return e.apply(this,arguments)}}();e.exports={auth:u,authWithPassword:l,authorize:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return function(r,t,n){return r.user?e.length&&!e.includes(r.user.role)?t.status(403).json({success:!1,error:"Access denied. Insufficient permissions."}):void n():t.status(401).json({success:!1,error:"Access denied. Authentication required."})}}}},245:(e,r,t)=>{function n(){var e,r,t="function"==typeof Symbol?Symbol:{},a=t.iterator||"@@iterator",i=t.toStringTag||"@@toStringTag";function s(t,n,a,i){var s=n&&n.prototype instanceof u?n:u,l=Object.create(s.prototype);return o(l,"_invoke",function(t,n,o){var a,i,s,u=0,l=o||[],p=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(r,t){return a=r,i=0,s=e,d.n=t,c}};function f(t,n){for(i=t,s=n,r=0;!p&&u&&!o&&r<l.length;r++){var o,a=l[r],f=d.p,m=a[2];t>3?(o=m===n)&&(s=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=t<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=t<3||a[0]>n||n>m)&&(a[4]=t,a[5]=n,d.n=m,i=0))}if(o||t>1)return c;throw p=!0,n}return function(o,l,m){if(u>1)throw TypeError("Generator is already running");for(p&&1===l&&f(l,m),i=l,s=m;(r=i<2?e:s)||!p;){a||(i?i<3?(i>1&&(d.n=-1),f(i,s)):d.n=s:d.v=s);try{if(u=2,a){if(i||(o="next"),r=a[o]){if(!(r=r.call(a,s)))throw TypeError("iterator result is not an object");if(!r.done)return r;s=r.value,i<2&&(i=0)}else 1===i&&(r=a.return)&&r.call(a),i<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((r=(p=d.n<0)?s:t.call(n,d))!==c)break}catch(r){a=e,i=1,s=r}finally{u=1}}return{value:r,done:p}}}(t,a,i),!0),l}var c={};function u(){}function l(){}function p(){}r=Object.getPrototypeOf;var d=[][a]?r(r([][a]())):(o(r={},a,function(){return this}),r),f=p.prototype=u.prototype=Object.create(d);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,o(e,i,"GeneratorFunction")),e.prototype=Object.create(f),e}return l.prototype=p,o(f,"constructor",p),o(p,"constructor",l),l.displayName="GeneratorFunction",o(p,i,"GeneratorFunction"),o(f),o(f,i,"Generator"),o(f,a,function(){return this}),o(f,"toString",function(){return"[object Generator]"}),(n=function(){return{w:s,m}})()}function o(e,r,t,n){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}o=function(e,r,t,n){function i(r,t){o(e,r,function(e){return this._invoke(r,t,e)})}r?a?a(e,r,{value:t,enumerable:!n,configurable:!n,writable:!n}):e[r]=t:(i("next",0),i("throw",1),i("return",2))},o(e,r,t,n)}function a(e,r,t,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void t(e)}s.done?r(c):Promise.resolve(c).then(n,o)}function i(e){return function(){var r=this,t=arguments;return new Promise(function(n,o){var i=e.apply(r,t);function s(e){a(i,n,o,s,c,"next",e)}function c(e){a(i,n,o,s,c,"throw",e)}s(void 0)})}}var s=t(288),c=(t(928),function(){var e=i(n().m(function e(r){var t,o,a,i,c,l,p,d,f,m,y=arguments;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:if(t=y.length>1&&void 0!==y[1]?y[1]:{},e.p=1,o=t.quality,a=void 0===o?85:o,i=t.originalMetadata,c=void 0===i?null:i,r&&0!==r.length){e.n=2;break}throw new Error("Empty or invalid image buffer");case 2:if(c){e.n=4;break}return e.n=3,u(r);case 3:e.v;case 4:return l=a,p=s(r),p=l<50?p.normalize().modulate({brightness:1,saturation:.95,hue:0}).blur(.3):p.normalize().modulate({brightness:1,saturation:.98,hue:0}),d={quality:l,effort:6,method:6,smartSubsample:!0,lossless:!1,nearLossless:!1,alphaQuality:Math.max(10,l-10),mixed:!0,preset:"photo"},l<30&&(d.reductionEffort=6,d.smartSubsample=!1),p=p.webp(d).withMetadata(!1),e.n=5,p.toBuffer();case 5:return f=e.v,e.a(2,f);case 6:throw e.p=6,m=e.v,console.error("❌ Image processing error:",m),new Error("Image processing failed: ".concat(m.message));case 7:return e.a(2)}},e,null,[[1,6]])}));return function(r){return e.apply(this,arguments)}}()),u=function(){var e=i(n().m(function e(r){var t,o;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,s(r).metadata();case 1:return t=e.v,e.a(2,{width:t.width,height:t.height,format:t.format,size:t.size,hasAlpha:t.hasAlpha,channels:t.channels});case 2:throw e.p=2,o=e.v,console.error("❌ Error getting image metadata:",o),new Error("Failed to get image metadata: ".concat(o.message));case 3:return e.a(2)}},e,null,[[0,2]])}));return function(r){return e.apply(this,arguments)}}(),l=function(){var e=i(n().m(function e(r){var t,o,a,i,s,c,l,p,d,f,m,y=arguments;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:if(t=y.length>1&&void 0!==y[1]?y[1]:{},e.p=1,o=t.maxSizeBytes,a=void 0===o?11534336:o,i=t.allowedFormats,s=void 0===i?["jpeg","jpg","png","webp"]:i,c=t.minWidth,l=void 0===c?100:c,p=t.minHeight,d=void 0===p?100:p,!(r.length>a)){e.n=2;break}throw new Error("Image too large: ".concat(r.length," bytes (max: ").concat(a," bytes)"));case 2:return e.n=3,u(r);case 3:if(f=e.v,s.includes(f.format.toLowerCase())){e.n=4;break}throw new Error("Unsupported format: ".concat(f.format," (allowed: ").concat(s.join(", "),")"));case 4:if(!(f.width<l||f.height<d)){e.n=5;break}throw new Error("Image too small: ".concat(f.width,"x").concat(f.height," (min: ").concat(l,"x").concat(d,")"));case 5:return e.a(2,!0);case 6:throw e.p=6,m=e.v,console.error("❌ Image validation error:",m),m;case 7:return e.a(2)}},e,null,[[1,6]])}));return function(r){return e.apply(this,arguments)}}();e.exports={processImage:c,getImageMetadata:u,validateImage:l}},250:e=>{"use strict";e.exports=require("dns")},252:e=>{"use strict";e.exports=require("express")},258:(e,r,t)=>{function n(){var e,r,t="function"==typeof Symbol?Symbol:{},a=t.iterator||"@@iterator",i=t.toStringTag||"@@toStringTag";function s(t,n,a,i){var s=n&&n.prototype instanceof u?n:u,l=Object.create(s.prototype);return o(l,"_invoke",function(t,n,o){var a,i,s,u=0,l=o||[],p=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(r,t){return a=r,i=0,s=e,d.n=t,c}};function f(t,n){for(i=t,s=n,r=0;!p&&u&&!o&&r<l.length;r++){var o,a=l[r],f=d.p,m=a[2];t>3?(o=m===n)&&(s=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=t<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=t<3||a[0]>n||n>m)&&(a[4]=t,a[5]=n,d.n=m,i=0))}if(o||t>1)return c;throw p=!0,n}return function(o,l,m){if(u>1)throw TypeError("Generator is already running");for(p&&1===l&&f(l,m),i=l,s=m;(r=i<2?e:s)||!p;){a||(i?i<3?(i>1&&(d.n=-1),f(i,s)):d.n=s:d.v=s);try{if(u=2,a){if(i||(o="next"),r=a[o]){if(!(r=r.call(a,s)))throw TypeError("iterator result is not an object");if(!r.done)return r;s=r.value,i<2&&(i=0)}else 1===i&&(r=a.return)&&r.call(a),i<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((r=(p=d.n<0)?s:t.call(n,d))!==c)break}catch(r){a=e,i=1,s=r}finally{u=1}}return{value:r,done:p}}}(t,a,i),!0),l}var c={};function u(){}function l(){}function p(){}r=Object.getPrototypeOf;var d=[][a]?r(r([][a]())):(o(r={},a,function(){return this}),r),f=p.prototype=u.prototype=Object.create(d);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,o(e,i,"GeneratorFunction")),e.prototype=Object.create(f),e}return l.prototype=p,o(f,"constructor",p),o(p,"constructor",l),l.displayName="GeneratorFunction",o(p,i,"GeneratorFunction"),o(f),o(f,i,"Generator"),o(f,a,function(){return this}),o(f,"toString",function(){return"[object Generator]"}),(n=function(){return{w:s,m}})()}function o(e,r,t,n){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}o=function(e,r,t,n){function i(r,t){o(e,r,function(e){return this._invoke(r,t,e)})}r?a?a(e,r,{value:t,enumerable:!n,configurable:!n,writable:!n}):e[r]=t:(i("next",0),i("throw",1),i("return",2))},o(e,r,t,n)}function a(e,r,t,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void t(e)}s.done?r(c):Promise.resolve(c).then(n,o)}var i=t(829),s=t(217),c=function(){var e,r=(e=n().m(function e(r,t,o){var a,c,u,l,p;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,(a=r.header("Authorization"))&&a.startsWith("Bearer ")){e.n=1;break}return r.user=null,e.a(2,o());case 1:if(c=a.substring(7)){e.n=2;break}return r.user=null,e.a(2,o());case 2:return e.p=2,u=i.verify(c,process.env.JWT_SECRET),e.n=3,s.findById(u.id).select("-password");case 3:if(l=e.v){e.n=4;break}return r.user=null,e.a(2,o());case 4:if(!l.isLocked||!l.isLocked()){e.n=5;break}return r.user=null,e.a(2,o());case 5:r.user=l,o(),e.n=7;break;case 6:e.p=6,e.v,r.user=null,o();case 7:e.n=9;break;case 8:e.p=8,p=e.v,console.error("Optional auth error:",p),r.user=null,o();case 9:return e.a(2)}},e,null,[[2,6],[0,8]])}),function(){var r=this,t=arguments;return new Promise(function(n,o){var i=e.apply(r,t);function s(e){a(i,n,o,s,c,"next",e)}function c(e){a(i,n,o,s,c,"throw",e)}s(void 0)})});return function(e,t,n){return r.apply(this,arguments)}}();e.exports=c},267:(e,r,t)=>{var n=t(252).Router(),o=t(226).auth,a=t(110),i=(a.handlePropertyImageUpload,a.handleSmartCompressedImageUpload,a.parseMultipartData),s=a.processValidatedImages;n.post("/images",o,i,function(e,r,t){if(!e.pendingImages||0===e.pendingImages.length)return r.status(400).json({success:!1,error:"At least one image is required for upload."});console.log("✅ Image upload validation passed"),t()},s,function(e,r){try{if(!e.uploadedImages||0===e.uploadedImages.length)return r.status(400).json({success:!1,error:"No images uploaded"});var t=e.uploadedImages.map(function(e,r){return{url:e.url,publicId:e.publicId,altText:e.altText||"Property image ".concat(r+1),order:r,isMain:0===r,originalName:e.originalName,size:e.size,originalSize:e.originalSize,compressionRatio:e.compressionRatio,format:e.format,width:e.width,height:e.height,compressed:e.compressionApplied,quality:e.quality,compressionApplied:e.compressionApplied,action:e.compressionApplied?"COMPRESSED":"AS-IS"}}),n=t.filter(function(e){return e.compressionApplied}),o=t.filter(function(e){return!e.compressionApplied}),a=t.reduce(function(e,r){return e+r.originalSize},0),i=t.reduce(function(e,r){return e+r.size},0),s=a-i,c=Math.round(s/a*100);r.status(200).json({success:!0,message:"Successfully uploaded and processed ".concat(t.length," images with smart compression"),statistics:{totalImages:t.length,compressed:n.length,asIs:o.length,originalTotalSize:"".concat(Math.round(a/1024),"KB"),finalTotalSize:"".concat(Math.round(i/1024),"KB"),totalSavings:"".concat(Math.round(s/1024),"KB"),overallCompression:"".concat(c,"%")},data:{images:t}})}catch(e){console.error("Image upload error:",e),r.status(500).json({success:!1,error:"Image upload failed",details:e.message})}}),e.exports=n},288:e=>{"use strict";e.exports=require("sharp")},342:(e,r,t)=>{function n(e){return function(e){if(Array.isArray(e))return o(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,r){if(e){if("string"==typeof e)return o(e,r);var t={}.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?o(e,r):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=Array(r);t<r;t++)n[t]=e[t];return n}function a(e){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a(e)}function i(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),t.push.apply(t,n)}return t}function s(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?i(Object(t),!0).forEach(function(r){c(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})}return e}function c(e,r,t){return(r=function(e){var r=function(e){if("object"!=a(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var t=r.call(e,"string");if("object"!=a(t))return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==a(r)?r:r+""}(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function u(){var e,r,t="function"==typeof Symbol?Symbol:{},n=t.iterator||"@@iterator",o=t.toStringTag||"@@toStringTag";function a(t,n,o,a){var c=n&&n.prototype instanceof s?n:s,u=Object.create(c.prototype);return l(u,"_invoke",function(t,n,o){var a,s,c,u=0,l=o||[],p=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(r,t){return a=r,s=0,c=e,d.n=t,i}};function f(t,n){for(s=t,c=n,r=0;!p&&u&&!o&&r<l.length;r++){var o,a=l[r],f=d.p,m=a[2];t>3?(o=m===n)&&(c=a[(s=a[4])?5:(s=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=t<2&&f<a[1])?(s=0,d.v=n,d.n=a[1]):f<m&&(o=t<3||a[0]>n||n>m)&&(a[4]=t,a[5]=n,d.n=m,s=0))}if(o||t>1)return i;throw p=!0,n}return function(o,l,m){if(u>1)throw TypeError("Generator is already running");for(p&&1===l&&f(l,m),s=l,c=m;(r=s<2?e:c)||!p;){a||(s?s<3?(s>1&&(d.n=-1),f(s,c)):d.n=c:d.v=c);try{if(u=2,a){if(s||(o="next"),r=a[o]){if(!(r=r.call(a,c)))throw TypeError("iterator result is not an object");if(!r.done)return r;c=r.value,s<2&&(s=0)}else 1===s&&(r=a.return)&&r.call(a),s<2&&(c=TypeError("The iterator does not provide a '"+o+"' method"),s=1);a=e}else if((r=(p=d.n<0)?c:t.call(n,d))!==i)break}catch(r){a=e,s=1,c=r}finally{u=1}}return{value:r,done:p}}}(t,o,a),!0),u}var i={};function s(){}function c(){}function p(){}r=Object.getPrototypeOf;var d=[][n]?r(r([][n]())):(l(r={},n,function(){return this}),r),f=p.prototype=s.prototype=Object.create(d);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,l(e,o,"GeneratorFunction")),e.prototype=Object.create(f),e}return c.prototype=p,l(f,"constructor",p),l(p,"constructor",c),c.displayName="GeneratorFunction",l(p,o,"GeneratorFunction"),l(f),l(f,o,"Generator"),l(f,n,function(){return this}),l(f,"toString",function(){return"[object Generator]"}),(u=function(){return{w:a,m}})()}function l(e,r,t,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}l=function(e,r,t,n){function a(r,t){l(e,r,function(e){return this._invoke(r,t,e)})}r?o?o(e,r,{value:t,enumerable:!n,configurable:!n,writable:!n}):e[r]=t:(a("next",0),a("throw",1),a("return",2))},l(e,r,t,n)}function p(e,r,t,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void t(e)}s.done?r(c):Promise.resolve(c).then(n,o)}function d(e){return function(){var r=this,t=arguments;return new Promise(function(n,o){var a=e.apply(r,t);function i(e){p(a,n,o,i,s,"next",e)}function s(e){p(a,n,o,i,s,"throw",e)}i(void 0)})}}var f=t(187),m=t(989),y=m.EMIRATES,g=m.PROPERTY_TYPES,h=m.PROPERTY_TYPE_AMENITIES_MAP,v=m.EMIRATE_AREA_MAP,b=(m.PROPERTY_STATUS,t(896).promises),w=t(928),E=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;switch(e){case"draft":return["draft","available"];case"available":return["available","pending","sold","rented","archived"];case"pending":default:return["pending","available","sold","rented","archived"];case"sold":case"rented":return[e,"archived"];case"archived":var t=["archived"];return r?t.includes(r)||t.push(r):console.warn("⚠️ Archived property found without previousStatus - this should not happen"),t}},S=function(){var e=d(u().m(function e(r){var t,n,o,a,i,s,c,l;return u().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,t=w.join(__dirname,"uploads"),console.log("🗑️ DELETE DEBUG - Attempting to delete files for publicId: ".concat(r)),console.log("🗑️ DELETE DEBUG - Upload directory: ".concat(t)),n=r,(o=[".webp",".jpg",".jpeg",".png"].some(function(e){return r.toLowerCase().endsWith(e)}))&&(a=r.lastIndexOf("."),n=r.substring(0,a),console.log("🗑️ DELETE DEBUG - PublicId has extension, using base: ".concat(n))),i=["".concat(n,".webp"),"".concat(n,"_thumb.webp"),"".concat(n,"_medium.webp"),"".concat(n,"_large.webp"),"".concat(n,"_original.webp"),"".concat(n,".jpg"),"".concat(n,".jpeg"),"".concat(n,".png")],o&&!i.includes(r)&&i.push(r),s=0,c=i.map(function(){var e=d(u().m(function e(r){var n;return u().w(function(e){for(;;)switch(e.p=e.n){case 0:return n=w.join(t,r),e.p=1,e.n=2,b.access(n);case 2:return e.n=3,b.unlink(n);case 3:console.log("🗑️ DELETE DEBUG - Successfully deleted: ".concat(r)),s++,e.n=5;break;case 4:e.p=4,e.v,console.log("🗑️ DELETE DEBUG - File not found or couldn't delete: ".concat(r));case 5:return e.a(2)}},e,null,[[1,4]])}));return function(r){return e.apply(this,arguments)}}()),e.n=1,Promise.all(c);case 1:console.log("🗑️ DELETE DEBUG - Total files deleted for ".concat(r,": ").concat(s)),e.n=3;break;case 2:throw e.p=2,l=e.v,console.error("❌ Error deleting local files for publicId ".concat(r,":"),l),l;case 3:return e.a(2)}},e,null,[[0,2]])}));return function(r){return e.apply(this,arguments)}}(),j=function(){var e=d(u().m(function e(r,t){var n,o;return u().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,r.user&&("admin"===r.user.role||"SuperAdmin"===r.user.role)){e.n=1;break}return e.a(2,t.status(403).json({success:!1,error:"Access denied. Admin privileges required."}));case 1:n=g.map(function(e){return{name:e}}),t.status(200).json({success:!0,data:{propertyTypes:n,total:n.length}}),e.n=3;break;case 2:e.p=2,o=e.v,console.error("Error fetching available property types:",o),t.status(500).json({success:!1,error:"Failed to fetch available property types"});case 3:return e.a(2)}},e,null,[[0,2]])}));return function(r,t){return e.apply(this,arguments)}}(),P=function(){var e=d(u().m(function e(r,t){var n,o,a,i,s;return u().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,r.user&&("admin"===r.user.role||"SuperAdmin"===r.user.role)){e.n=1;break}return e.a(2,t.status(403).json({success:!1,error:"Access denied. Admin privileges required."}));case 1:if((n=r.params.propertyType)&&"string"==typeof n){e.n=2;break}return e.a(2,t.status(400).json({success:!1,error:"Property type parameter is required and must be a string"}));case 2:o=n.trim().replace(/[<>\"'&]/g,""),(a=g.find(function(e){return e.toLowerCase()===o.toLowerCase()}))&&(i=h[a]||[],t.status(200).json({success:!0,data:{propertyType:a,all:i,total:i.length}})),e.n=4;break;case 3:e.p=3,s=e.v,console.error("Error fetching amenities for property type:",s),t.status(500).json({success:!1,error:"Failed to fetch amenities for property type"});case 4:return e.a(2)}},e,null,[[0,3]])}));return function(r,t){return e.apply(this,arguments)}}(),A=function(){var e=d(u().m(function e(r,t){var n,o,a,i,c,l,p,d,m,y,g,h,v,b,w,E,S,j,P,A,k,I,O,T,x,q,_;return u().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,n=r.query,o=n.page,a=void 0===o?1:o,i=n.limit,c=void 0===i?10:i,l=n.emirate,p=n.area,d=n.propertyType,m=n.listingType,y=n.minPrice,g=n.maxPrice,h=n.bedrooms,v=n.status,b=n.approvalStatus,w=n.search,E=n.sortBy,S=void 0===E?"createdAt":E,j=n.sortOrder,P=void 0===j?"desc":j,A=s({},r.queryFilters)||{},"SuperAdmin"===(k=r.userRole||"visitor")||"admin"===k||(A.approvalStatus="approved"),v&&("admin"===k||"SuperAdmin"===k||["available","sold","rented","pending"].includes(v))&&(A.status=v),l&&(A["location.emirate"]=l),p&&(A["location.area"]=p),d&&(A.propertyType=d),m&&(A.listingType=m),h&&(A["details.bedrooms"]=parseInt(h)),(y||g)&&(A.price={},y&&(A.price.$gte=parseInt(y)),g&&(A.price.$lte=parseInt(g))),!b||"admin"!==k&&"SuperAdmin"!==k||"pending"!==b&&"approved"!==b&&"rejected"!==b&&"not_applicable"!==b||(delete A.approvalStatus,delete A.$or,A.approvalStatus=b,"admin"===k&&r.user&&r.user.id&&("approved"===b?A.approvalStatus="approved":(A.$and=[{approvalStatus:b},{createdBy:r.user.id}],delete A.approvalStatus))),w&&w.trim()&&(I=new RegExp(w.trim(),"i"),A.$and=A.$and||[],A.$and.push({$or:[{title:I},{description:I},{"location.address":I},{"location.area":I},{"location.emirate":I}]})),(O={})[S]="asc"===P?1:-1,T=(parseInt(a)-1)*parseInt(c),e.n=1,f.find(A).populate("createdBy","name email role").sort(O).skip(T).limit(parseInt(c));case 1:return x=e.v,e.n=2,f.countDocuments(A);case 2:q=e.v,t.status(200).json({success:!0,data:s({properties:x,pagination:{current:parseInt(a),pages:Math.ceil(q/parseInt(c)),total:q,limit:parseInt(c)}},"admin"===k&&{appliedFilters:A})}),e.n=4;break;case 3:e.p=3,_=e.v,console.error("Error fetching properties:",_),t.status(500).json({success:!1,error:"Failed to fetch properties"});case 4:return e.a(2)}},e,null,[[0,3]])}));return function(r,t){return e.apply(this,arguments)}}(),k=function(){var e=d(u().m(function e(r,t){var n,o,a,i,c;return u().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,n=r.params.id,o=r.userRole||"visitor",a=r.queryFilters||{},i=null,e.p=1,e.n=2,f.findOne(s({_id:n},a)).populate("createdBy","name email");case 2:i=e.v,e.n=4;break;case 3:e.p=3,e.v;case 4:if(i){e.n=6;break}return e.n=5,f.findOne(s({slug:n},a)).populate("createdBy","name email");case 5:i=e.v;case 6:if(i){e.n=7;break}return e.a(2,t.status(404).json({success:!1,error:"admin"===o?"Property not found":"Property not found or not available for public viewing"}));case 7:t.status(200).json({success:!0,data:{property:i}}),e.n=9;break;case 8:e.p=8,c=e.v,console.error("Error fetching property:",c),t.status(500).json({success:!1,error:"Failed to fetch property"});case 9:return e.a(2)}},e,null,[[1,3],[0,8]])}));return function(r,t){return e.apply(this,arguments)}}(),I=function(){var e=d(u().m(function e(r,t){var n,o,a,i,c,l,p,d,m,y,g;return u().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,"draft"===(n=s(s({},r.body),{},{createdBy:r.user.id})).status?n.approvalStatus="not_applicable":"SuperAdmin"===r.user.role?(n.approvalStatus="approved",n.updatedBy=r.user.id,n.updatedAt=new Date):n.approvalStatus="pending",o=null,a=[],!(r.uploadedImages&&r.uploadedImages.length>0)){e.n=1;break}o="uploaded",a=r.uploadedImages,e.n=3;break;case 1:if(!(r.body.images&&Array.isArray(r.body.images)&&r.body.images.length>0)){e.n=2;break}o="pre-processed",a=r.body.images,e.n=3;break;case 2:return e.a(2,t.status(400).json({success:!1,error:"At least one property image is required. Either upload image files or provide pre-processed image data."}));case 3:return n.images=a.map(function(e,r){return{url:e.url,publicId:e.publicId,altText:e.altText||"Property image ".concat(r+1),order:void 0!==e.order?e.order:r,isMain:void 0!==e.isMain?e.isMain:0===r,originalName:e.originalName,size:e.size,format:e.format}}),i=new f(n),e.n=4,i.save();case 4:c={success:!0,data:{property:i},message:"Property created successfully with ".concat(n.images.length," ").concat(o," images")},r.validationWarnings&&r.validationWarnings.length>0&&(c.warnings=r.validationWarnings),t.status(201).json(c),e.n=8;break;case 5:if(e.p=5,g=e.v,console.error("Error creating property with images:",g),11e3!==g.code){e.n=6;break}return l=Object.keys(g.keyPattern)[0],g.keyValue[l],p=l,d="".concat(l.charAt(0).toUpperCase()+l.slice(1)," already exists"),"slug"===l&&(p="title",d="A property with this title already exists. Please choose a different title."),m={success:!1,error:"Property with this ".concat("slug"===l?"title":l," already exists"),details:[{field:p,message:d}]},e.a(2,t.status(400).json(m));case 6:if("ValidationError"!==g.name){e.n=7;break}return y=Object.values(g.errors).map(function(e){return e.message}),e.a(2,t.status(400).json({success:!1,error:"Validation failed",details:y}));case 7:t.status(500).json({success:!1,error:"Failed to create property with images"});case 8:return e.a(2)}},e,null,[[0,5]])}));return function(r,t){return e.apply(this,arguments)}}(),O=function(){var e=d(u().m(function e(r,t){var o,i,c,l,p,m,y,g,h,v,b,w,j,P,A,k,I,O,T,x,q,_,R,M,F,B,D,N,U,C,G,L,$;return u().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,!(m=r.params.id).match(/^[0-9a-fA-F]{24}$/)){e.n=2;break}return e.n=1,f.findById(m);case 1:y=e.v,e.n=4;break;case 2:return e.n=3,f.findOne({slug:m});case 3:y=e.v;case 4:if(y){e.n=5;break}return e.a(2,t.status(404).json({success:!1,error:"Property not found"}));case 5:if(!r.requireOwnership||"admin"!==r.userRole){e.n=6;break}if((null===(g=y.createdBy)||void 0===g?void 0:g.toString())===r.user.id.toString()){e.n=6;break}return e.a(2,t.status(403).json({success:!1,error:"Access denied - You can only update properties you created"}));case 6:if(h=r.body,console.log("=== UPDATE PROPERTY DEBUG ==="),console.log("Received emirate:",null===(o=h.location)||void 0===o?void 0:o.emirate),console.log("Received area:",null===(i=h.location)||void 0===i?void 0:i.area,"(type:",a(null===(c=h.location)||void 0===c?void 0:c.area),")"),console.log("Existing emirate:",null===(l=y.location)||void 0===l?void 0:l.emirate),console.log("Existing area:",null===(p=y.location)||void 0===p?void 0:p.area),console.log("✅ Using property data from req.body:",Object.keys(h)),!h.status||h.status===y.status){e.n=8;break}if(v=y.status,b=h.status,(w=E(v,y.previousStatus)).includes(b)){e.n=7;break}return e.a(2,t.status(400).json({success:!1,error:"Invalid status transition: Cannot change status from '".concat(v,"' to '").concat(b,"'"),details:{currentStatus:v,attemptedStatus:b,allowedTransitions:w}}));case 7:"archived"===b&&"archived"!==v?h.previousStatus=v:"archived"===v&&"archived"!==b&&(h.previousStatus=void 0);case 8:if(j=s(s({},h),{},{updatedBy:r.user.id}),P=function(){void 0!==y.rejectionReason&&(y.rejectionReason=void 0)},void 0!==h.status?(A=y.status,k=h.status,"draft"===A&&"draft"!==k?("SuperAdmin"===r.user.role?updateOperation.$set.approvalStatus="approved":updateOperation.$set.approvalStatus="pending",P()):"draft"!==A&&"draft"===k?(updateOperation.$set.approvalStatus="not_applicable",P()):"draft"!==A&&"draft"!==k&&("admin"===r.user.role?(updateOperation.$set.approvalStatus="pending",P()):"SuperAdmin"===r.user.role&&(updateOperation.$set.approvalStatus="approved",P()))):"draft"!==y.status&&("admin"===r.user.role?(updateOperation.$set.approvalStatus="pending",P()):"SuperAdmin"===r.user.role&&(updateOperation.$set.approvalStatus="approved",P())),I=[],O=!1,void 0!==h.existingImages){O=!0;try{T=JSON.parse(h.existingImages),Array.isArray(T)&&(I=n(T),console.log("📷 Keeping ".concat(T.length," existing images")))}catch(e){console.error("❌ Error parsing existingImages:",e)}}if(r.uploadedImages&&r.uploadedImages.length>0&&(O=!0,console.log("📷 Adding ".concat(r.uploadedImages.length," new images")),x=r.uploadedImages.map(function(e,t){var n=r.imageMetadata&&r.imageMetadata[t]?r.imageMetadata[t]:{};return{url:e.url,publicId:e.publicId,altText:n.altText||"Property image ".concat(I.length+t+1),order:I.length+t,isMain:"true"===n.isMain||!0===n.isMain,originalName:e.originalName,size:e.size,format:e.format,width:e.width,height:e.height}}),I=[].concat(n(I),n(x))),!O){e.n=11;break}if(q=y.images.map(function(e){return e.publicId}),_=I.map(function(e){return e.publicId}),R=q.filter(function(e){return!_.includes(e)}),!(R.length>0)){e.n=9;break}return console.log("🗑️ UPDATE DEBUG - Found ".concat(R.length," images to delete:"),R),M=R.map(function(){var e=d(u().m(function e(r){var t;return u().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,S(r);case 1:console.log("✅ Successfully deleted local files for removed image: ".concat(r)),e.n=3;break;case 2:e.p=2,t=e.v,console.error("❌ Failed to delete local files for image ".concat(r,":"),t);case 3:return e.a(2)}},e,null,[[0,2]])}));return function(r){return e.apply(this,arguments)}}()),e.n=9,Promise.allSettled(M);case 9:if(I.length>0&&((F=I.filter(function(e){return e.isMain})).length>1?(B=!1,I=I.map(function(e){return e.isMain&&!B?(B=!0,e):e.isMain&&B?s(s({},e),{},{isMain:!1}):e})):0===F.length&&(I[0].isMain=!0),I=I.map(function(e,r){return s(s({},e),{},{order:r})})),0!==I.length){e.n=10;break}return e.a(2,t.status(400).json({success:!1,error:"At least one image is required",details:[{field:"images",message:"At least one image is required"}]}));case 10:j.images=I,console.log("📷 Image update requested - Final images count: ".concat(I.length)),e.n=12;break;case 11:console.log("📷 No image changes requested, keeping existing images");case 12:return Object.assign(y,j),e.n=13,y.save();case 13:return D=e.v,e.n=14,D.populate("createdBy updatedBy","name email");case 14:t.status(200).json({success:!0,data:{property:D},message:"Property updated successfully"}),e.n=18;break;case 15:if(e.p=15,$=e.v,console.error("Error updating property:",$),11e3!==$.code){e.n=16;break}return N=Object.keys($.keyPattern)[0],$.keyValue[N],U=N,C="".concat(N.charAt(0).toUpperCase()+N.slice(1)," already exists"),"slug"===N&&(U="title",C="A property with this title already exists. Please choose a different title."),G={success:!1,error:"Property with this ".concat("slug"===N?"title":N," already exists"),details:[{field:U,message:C}]},e.a(2,t.status(400).json(G));case 16:if("ValidationError"!==$.name){e.n=17;break}return L=Object.values($.errors).map(function(e){return e.message}),e.a(2,t.status(400).json({success:!1,error:"Validation failed",details:L}));case 17:t.status(500).json({success:!1,error:"Failed to update property"});case 18:return e.a(2)}},e,null,[[0,15]])}));return function(r,t){return e.apply(this,arguments)}}(),T=function(){var e=d(u().m(function e(r,t){var n,o,a,i,s,c;return u().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,!(o=r.params.id).match(/^[0-9a-fA-F]{24}$/)){e.n=2;break}return e.n=1,f.findById(o);case 1:a=e.v,e.n=4;break;case 2:return e.n=3,f.findOne({slug:o});case 3:a=e.v;case 4:if(a){e.n=5;break}return e.a(2,t.status(404).json({success:!1,error:"Property not found"}));case 5:if(!r.requireOwnership||"admin"!==r.userRole){e.n=7;break}if((null===(i=a.createdBy)||void 0===i?void 0:i.toString())===r.user.id.toString()){e.n=6;break}return e.a(2,t.status(403).json({success:!1,error:"Access denied - You can only delete properties you created"}));case 6:if("rejected"===a.approvalStatus||"draft"===a.status){e.n=7;break}return e.a(2,t.status(403).json({success:!1,error:"Cannot delete property. Only rejected or draft properties can be deleted by admin.",details:{currentStatus:a.status,currentApprovalStatus:a.approvalStatus,allowedConditions:"status = 'draft' OR approvalStatus = 'rejected'",message:"pending"===a.approvalStatus?"Property is awaiting SuperAdmin approval":"approved"===a.approvalStatus?"Property has been approved and cannot be deleted":"Property is not in a deletable state"}}));case 7:if(!(a.images&&a.images.length>0)){e.n=9;break}return s=a.images.map(function(e){return S(e.publicId).catch(function(r){console.error("Failed to delete local image ".concat(e.publicId,":"),r)})}),e.n=8,Promise.allSettled(s);case 8:console.log("🗑️ Attempted to delete ".concat(a.images.length," images from local storage"));case 9:return e.n=10,f.findByIdAndDelete(a._id);case 10:t.status(200).json({success:!0,message:"Property deleted successfully along with ".concat((null===(n=a.images)||void 0===n?void 0:n.length)||0," images")}),e.n=12;break;case 11:e.p=11,c=e.v,console.error("Error deleting property:",c),t.status(500).json({success:!1,error:"Failed to delete property"});case 12:return e.a(2)}},e,null,[[0,11]])}));return function(r,t){return e.apply(this,arguments)}}(),x=function(){var e=d(u().m(function e(r,t){var n,o,a,i,s,c,l,p,d;return u().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,n=r.params,o=n.id,a=n.imageId,!o.match(/^[0-9a-fA-F]{24}$/)){e.n=2;break}return e.n=1,f.findById(o);case 1:i=e.v,e.n=4;break;case 2:return e.n=3,f.findOne({slug:o});case 3:i=e.v;case 4:if(i){e.n=5;break}return e.a(2,t.status(404).json({success:!1,error:"Property not found"}));case 5:if(!r.requireOwnership||"admin"!==r.userRole){e.n=6;break}if((null===(s=i.createdBy)||void 0===s?void 0:s.toString())===r.user.id){e.n=6;break}return e.a(2,t.status(403).json({success:!1,error:"Access denied - You can only manage images of properties you created"}));case 6:if(-1!==(c=i.images.findIndex(function(e){return e._id.toString()===a}))){e.n=7;break}return e.a(2,t.status(404).json({success:!1,error:"Image not found"}));case 7:return l=i.images[c],e.p=8,e.n=9,S(l.publicId);case 9:console.log("✅ Successfully deleted local files for image: ".concat(l.publicId)),e.n=11;break;case 10:e.p=10,p=e.v,console.error("Failed to delete image from local storage:",p);case 11:return i.images.splice(c,1),l.isMain&&i.images.length>0&&(i.images[0].isMain=!0),e.n=12,i.save();case 12:t.status(200).json({success:!0,message:"Image deleted successfully",data:{property:i}}),e.n=14;break;case 13:e.p=13,d=e.v,console.error("Error deleting property image:",d),t.status(500).json({success:!1,error:"Failed to delete image"});case 14:return e.a(2)}},e,null,[[8,10],[0,13]])}));return function(r,t){return e.apply(this,arguments)}}(),q=function(){var e=d(u().m(function e(r,t){var n,o,a,i,s,c,l;return u().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,n=r.params,o=n.id,a=n.imageId,!o.match(/^[0-9a-fA-F]{24}$/)){e.n=2;break}return e.n=1,f.findById(o);case 1:i=e.v,e.n=4;break;case 2:return e.n=3,f.findOne({slug:o});case 3:i=e.v;case 4:if(i){e.n=5;break}return e.a(2,t.status(404).json({success:!1,error:"Property not found"}));case 5:if(!r.requireOwnership||"admin"!==r.userRole){e.n=6;break}if((null===(s=i.createdBy)||void 0===s?void 0:s.toString())===r.user.id){e.n=6;break}return e.a(2,t.status(403).json({success:!1,error:"Access denied - You can only manage images of properties you created"}));case 6:if(-1!==(c=i.images.findIndex(function(e){return e._id.toString()===a}))){e.n=7;break}return e.a(2,t.status(404).json({success:!1,error:"Image not found"}));case 7:return i.images.forEach(function(e,r){e.isMain=r===c}),e.n=8,i.save();case 8:t.status(200).json({success:!0,message:"Main image updated successfully",data:{property:i}}),e.n=10;break;case 9:e.p=9,l=e.v,console.error("Error setting main property image:",l),t.status(500).json({success:!1,error:"Failed to set main image"});case 10:return e.a(2)}},e,null,[[0,9]])}));return function(r,t){return e.apply(this,arguments)}}(),_=function(){var e=d(u().m(function e(r,t){var n,o,a,i,c,l,p,d,m;return u().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,"draft"===(n=s(s({},r.body),{},{createdBy:r.user.id,images:[]})).status?n.approvalStatus="not_applicable":"SuperAdmin"===r.user.role?(n.approvalStatus="approved",n.updatedBy=r.user.id,n.updatedAt=new Date):n.approvalStatus="pending",o=new f(n),e.n=1,o.save();case 1:a={success:!0,data:{property:o},message:"Property created successfully without images"},r.validationWarnings&&r.validationWarnings.length>0&&(a.warnings=r.validationWarnings),t.status(201).json(a),e.n=5;break;case 2:if(e.p=2,m=e.v,console.error("Error creating property without images:",m),11e3!==m.code){e.n=3;break}return i=Object.keys(m.keyPattern)[0],m.keyValue[i],c=i,l="".concat(i.charAt(0).toUpperCase()+i.slice(1)," already exists"),"slug"===i&&(c="title",l="A property with this title already exists. Please choose a different title."),p={success:!1,error:"Property with this ".concat("slug"===i?"title":i," already exists"),details:[{field:c,message:l}]},e.a(2,t.status(400).json(p));case 3:if("ValidationError"!==m.name){e.n=4;break}return d=Object.values(m.errors).map(function(e){return e.message}),e.a(2,t.status(400).json({success:!1,error:"Validation failed",details:d}));case 4:t.status(500).json({success:!1,error:"Failed to create property without images"});case 5:return e.a(2)}},e,null,[[0,2]])}));return function(r,t){return e.apply(this,arguments)}}(),R=function(){var e=d(u().m(function e(r,t){var n,o,i,c,l,p,d,m,y,g,h,v,b,w,S,j,P,A,k,I,O,T,x,q,_,R,M;return u().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,!(p=r.params.id).match(/^[0-9a-fA-F]{24}$/)){e.n=2;break}return e.n=1,f.findById(p);case 1:d=e.v,e.n=4;break;case 2:return e.n=3,f.findOne({slug:p});case 3:d=e.v;case 4:if(d){e.n=5;break}return e.a(2,t.status(404).json({success:!1,error:"Property not found"}));case 5:if(!r.requireOwnership||"admin"!==r.userRole){e.n=6;break}if((null===(m=d.createdBy)||void 0===m?void 0:m.toString())===r.user.id.toString()){e.n=6;break}return e.a(2,t.status(403).json({success:!1,error:"Access denied - You can only update properties you created"}));case 6:if(y=r.body,console.log("=== UPDATE PROPERTY WITHOUT IMAGES DEBUG ==="),console.log("Received emirate:",null===(n=y.location)||void 0===n?void 0:n.emirate),console.log("Received area:",null===(o=y.location)||void 0===o?void 0:o.area,"(type:",a(null===(i=y.location)||void 0===i?void 0:i.area),")"),console.log("Existing emirate:",null===(c=d.location)||void 0===c?void 0:c.emirate),console.log("Existing area:",null===(l=d.location)||void 0===l?void 0:l.area),console.log("✅ Using property data from req.body:",Object.keys(y)),!y.status||y.status===d.status){e.n=8;break}if(g=d.status,h=y.status,(v=E(g,d.previousStatus)).includes(h)){e.n=7;break}return e.a(2,t.status(400).json({success:!1,error:"Invalid status transition: Cannot change status from '".concat(g,"' to '").concat(h,"'"),details:{currentStatus:g,attemptedStatus:h,allowedTransitions:v}}));case 7:"archived"===h&&"archived"!==g?y.previousStatus=g:"archived"===g&&"archived"!==h&&(y.previousStatus=void 0);case 8:return b=s({},y),w={},S=b.price,""===b.price?(delete b.price,w={$set:s(s({},b),{},{updatedBy:r.user.id,images:d.images}),$unset:{price:1}}):w={$set:s(s({},b),{},{updatedBy:r.user.id,images:d.images})},j=function(){void 0!==d.rejectionReason&&(d.rejectionReason=void 0)},void 0!==y.status?(P=d.status,A=y.status,"draft"===P&&"draft"!==A?("SuperAdmin"===r.user.role?w.$set.approvalStatus="approved":w.$set.approvalStatus="pending",j()):"draft"!==P&&"draft"===A?(w.$set.approvalStatus="not_applicable",j()):"draft"!==P&&"draft"!==A&&("admin"===r.user.role?(w.$set.approvalStatus="pending",j()):"SuperAdmin"===r.user.role&&(w.$set.approvalStatus="approved",j()))):"draft"!==d.status&&("admin"===r.user.role?(w.$set.approvalStatus="pending",j()):"SuperAdmin"===r.user.role&&(w.$set.approvalStatus="approved",j())),k=b.listingType||d.listingType,I={new:!0,runValidators:"off plan"===k||"off plan"!==k&&""!==S},e.n=9,f.findByIdAndUpdate(d._id,w,I).populate("createdBy","name email");case 9:if(O=e.v){e.n=10;break}return e.a(2,t.status(404).json({success:!1,error:"Property not found after update"}));case 10:t.status(200).json({success:!0,data:{property:O},message:"Property updated successfully without modifying images"}),e.n=14;break;case 11:if(e.p=11,M=e.v,console.error("Error updating property without images:",M),11e3!==M.code){e.n=12;break}return T=Object.keys(M.keyPattern)[0],M.keyValue[T],x=T,q="".concat(T.charAt(0).toUpperCase()+T.slice(1)," already exists"),"slug"===T&&(x="title",q="A property with this title already exists. Please choose a different title."),_={success:!1,error:"Property with this ".concat("slug"===T?"title":T," already exists"),details:[{field:x,message:q}]},e.a(2,t.status(400).json(_));case 12:if("ValidationError"!==M.name){e.n=13;break}return R=Object.values(M.errors).map(function(e){return e.message}),e.a(2,t.status(400).json({success:!1,error:"Validation failed",details:R}));case 13:t.status(500).json({success:!1,error:"Failed to update property without images"});case 14:return e.a(2)}},e,null,[[0,11]])}));return function(r,t){return e.apply(this,arguments)}}();e.exports={getAreasForEmirate:function(e,r){try{if(!e.user||"admin"!==e.user.role&&"SuperAdmin"!==e.user.role)return r.status(403).json({success:!1,error:"Access denied. Admin privileges required."});var t=e.params.emirate;if(!t||"string"!=typeof t)return r.status(400).json({success:!1,error:"Emirate parameter is required and must be a string"});var n=t.trim().replace(/[<>\"'&]/g,""),o=y.find(function(e){return e.toLowerCase()===n.toLowerCase()});if(!o)return r.status(400).json({success:!1,error:"Invalid emirate. Valid options are: ".concat(y.join(", "))});var a=v[o]||[];r.status(200).json({success:!0,data:{emirate:o,areas:a,count:a.length},message:"Found ".concat(a.length," areas in ").concat(o)})}catch(e){console.error("Error fetching areas for emirate:",e),r.status(500).json({success:!1,error:"Failed to fetch areas for emirate"})}},getAmenitiesForPropertyType:P,getAvailablePropertyTypes:j,getProperties:A,getProperty:k,createPropertyWithImages:I,createPropertyWithoutImages:_,updateProperty:O,updatePropertyWithoutImages:R,deleteProperty:T,deletePropertyImage:x,setMainPropertyImage:q}},357:(e,r,t)=>{function n(){var e,r,t="function"==typeof Symbol?Symbol:{},a=t.iterator||"@@iterator",i=t.toStringTag||"@@toStringTag";function s(t,n,a,i){var s=n&&n.prototype instanceof u?n:u,l=Object.create(s.prototype);return o(l,"_invoke",function(t,n,o){var a,i,s,u=0,l=o||[],p=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(r,t){return a=r,i=0,s=e,d.n=t,c}};function f(t,n){for(i=t,s=n,r=0;!p&&u&&!o&&r<l.length;r++){var o,a=l[r],f=d.p,m=a[2];t>3?(o=m===n)&&(s=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=t<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=t<3||a[0]>n||n>m)&&(a[4]=t,a[5]=n,d.n=m,i=0))}if(o||t>1)return c;throw p=!0,n}return function(o,l,m){if(u>1)throw TypeError("Generator is already running");for(p&&1===l&&f(l,m),i=l,s=m;(r=i<2?e:s)||!p;){a||(i?i<3?(i>1&&(d.n=-1),f(i,s)):d.n=s:d.v=s);try{if(u=2,a){if(i||(o="next"),r=a[o]){if(!(r=r.call(a,s)))throw TypeError("iterator result is not an object");if(!r.done)return r;s=r.value,i<2&&(i=0)}else 1===i&&(r=a.return)&&r.call(a),i<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((r=(p=d.n<0)?s:t.call(n,d))!==c)break}catch(r){a=e,i=1,s=r}finally{u=1}}return{value:r,done:p}}}(t,a,i),!0),l}var c={};function u(){}function l(){}function p(){}r=Object.getPrototypeOf;var d=[][a]?r(r([][a]())):(o(r={},a,function(){return this}),r),f=p.prototype=u.prototype=Object.create(d);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,o(e,i,"GeneratorFunction")),e.prototype=Object.create(f),e}return l.prototype=p,o(f,"constructor",p),o(p,"constructor",l),l.displayName="GeneratorFunction",o(p,i,"GeneratorFunction"),o(f),o(f,i,"Generator"),o(f,a,function(){return this}),o(f,"toString",function(){return"[object Generator]"}),(n=function(){return{w:s,m}})()}function o(e,r,t,n){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}o=function(e,r,t,n){function i(r,t){o(e,r,function(e){return this._invoke(r,t,e)})}r?a?a(e,r,{value:t,enumerable:!n,configurable:!n,writable:!n}):e[r]=t:(i("next",0),i("throw",1),i("return",2))},o(e,r,t,n)}function a(e,r,t,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void t(e)}s.done?r(c):Promise.resolve(c).then(n,o)}function i(e){return function(){var r=this,t=arguments;return new Promise(function(n,o){var i=e.apply(r,t);function s(e){a(i,n,o,s,c,"next",e)}function c(e){a(i,n,o,s,c,"throw",e)}s(void 0)})}}var s=t(217),c=function(){var e=i(n().m(function e(r,t){var o,a,i,c,u,l;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,o=r.body,a=o.username,i=o.password,e.n=1,s.findOne({username:a}).select("+password");case 1:if(c=e.v){e.n=2;break}return e.a(2,t.status(401).json({success:!1,error:"Invalid credentials"}));case 2:if(c.isActive){e.n=3;break}return e.a(2,t.status(403).json({success:!1,error:"Account is not active. Please contact SuperAdmin."}));case 3:if(!c.isLocked()){e.n=4;break}return e.a(2,t.status(423).json({success:!1,error:"Account is temporarily locked due to too many failed login attempts. Please try again later.",lockUntil:c.lockUntil}));case 4:return e.n=5,c.comparePassword(i);case 5:if(e.v){e.n=7;break}return e.n=6,c.incrementLoginAttempts();case 6:return e.a(2,t.status(401).json({success:!1,error:"Invalid credentials",attemptsRemaining:Math.max(0,parseInt(process.env.MAX_LOGIN_ATTEMPTS)-c.loginAttempts)}));case 7:return e.n=8,c.updateLastLogin();case 8:u=c.generateAuthToken(),t.status(200).json({success:!0,data:{user:{id:c._id,username:c.username,name:c.name,email:c.email,role:c.role,isActive:c.isActive,lastLogin:c.lastLogin},token:u},message:"Login successful"}),e.n=10;break;case 9:e.p=9,l=e.v,console.error("Error during login:",l),t.status(500).json({success:!1,error:"Login failed"});case 10:return e.a(2)}},e,null,[[0,9]])}));return function(r,t){return e.apply(this,arguments)}}(),u=function(){var e=i(n().m(function e(r,t){var o,a,i,s,c;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,o=r.body,a=o.currentPassword,i=o.newPassword,s=r.userDocument){e.n=1;break}return e.a(2,t.status(500).json({success:!1,error:"Authentication error. Please try again."}));case 1:return e.n=2,s.comparePassword(a);case 2:if(e.v){e.n=3;break}return e.a(2,t.status(401).json({success:!1,error:"Current password is incorrect"}));case 3:return s.password=i,s.passwordChangedAt=new Date,e.n=4,s.save();case 4:t.status(200).json({success:!0,message:"Password changed successfully",data:{passwordChangedAt:s.passwordChangedAt}}),e.n=6;break;case 5:e.p=5,c=e.v,console.error("❌ Error changing password:",c),t.status(500).json({success:!1,error:"Failed to change password"});case 6:return e.a(2)}},e,null,[[0,5]])}));return function(r,t){return e.apply(this,arguments)}}();e.exports={login:c,changePassword:u}},392:(e,r,t)=>{function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function o(e){if(null!=e){var r=e["function"==typeof Symbol&&Symbol.iterator||"@@iterator"],t=0;if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length))return{next:function(){return e&&t>=e.length&&(e=void 0),{value:e&&e[t++],done:!e}}}}throw new TypeError(n(e)+" is not iterable")}function a(e,r){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=l(e))||r&&e&&"number"==typeof e.length){t&&(e=t);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,s=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return i=e.done,e},e:function(e){s=!0,a=e},f:function(){try{i||null==t.return||t.return()}finally{if(s)throw a}}}}function i(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),t.push.apply(t,n)}return t}function s(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?i(Object(t),!0).forEach(function(r){c(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})}return e}function c(e,r,t){return(r=function(e){var r=function(e){if("object"!=n(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var t=r.call(e,"string");if("object"!=n(t))return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==n(r)?r:r+""}(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function u(e,r){return function(e){if(Array.isArray(e))return e}(e)||function(e,r){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var n,o,a,i,s=[],c=!0,u=!1;try{if(a=(t=t.call(e)).next,0===r){if(Object(t)!==t)return;c=!1}else for(;!(c=(n=a.call(t)).done)&&(s.push(n.value),s.length!==r);c=!0);}catch(e){u=!0,o=e}finally{try{if(!c&&null!=t.return&&(i=t.return(),Object(i)!==i))return}finally{if(u)throw o}}return s}}(e,r)||l(e,r)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function l(e,r){if(e){if("string"==typeof e)return p(e,r);var t={}.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?p(e,r):void 0}}function p(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=Array(r);t<r;t++)n[t]=e[t];return n}function d(){var e,r,t="function"==typeof Symbol?Symbol:{},n=t.iterator||"@@iterator",o=t.toStringTag||"@@toStringTag";function a(t,n,o,a){var c=n&&n.prototype instanceof s?n:s,u=Object.create(c.prototype);return f(u,"_invoke",function(t,n,o){var a,s,c,u=0,l=o||[],p=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(r,t){return a=r,s=0,c=e,d.n=t,i}};function f(t,n){for(s=t,c=n,r=0;!p&&u&&!o&&r<l.length;r++){var o,a=l[r],f=d.p,m=a[2];t>3?(o=m===n)&&(c=a[(s=a[4])?5:(s=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=t<2&&f<a[1])?(s=0,d.v=n,d.n=a[1]):f<m&&(o=t<3||a[0]>n||n>m)&&(a[4]=t,a[5]=n,d.n=m,s=0))}if(o||t>1)return i;throw p=!0,n}return function(o,l,m){if(u>1)throw TypeError("Generator is already running");for(p&&1===l&&f(l,m),s=l,c=m;(r=s<2?e:c)||!p;){a||(s?s<3?(s>1&&(d.n=-1),f(s,c)):d.n=c:d.v=c);try{if(u=2,a){if(s||(o="next"),r=a[o]){if(!(r=r.call(a,c)))throw TypeError("iterator result is not an object");if(!r.done)return r;c=r.value,s<2&&(s=0)}else 1===s&&(r=a.return)&&r.call(a),s<2&&(c=TypeError("The iterator does not provide a '"+o+"' method"),s=1);a=e}else if((r=(p=d.n<0)?c:t.call(n,d))!==i)break}catch(r){a=e,s=1,c=r}finally{u=1}}return{value:r,done:p}}}(t,o,a),!0),u}var i={};function s(){}function c(){}function u(){}r=Object.getPrototypeOf;var l=[][n]?r(r([][n]())):(f(r={},n,function(){return this}),r),p=u.prototype=s.prototype=Object.create(l);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,f(e,o,"GeneratorFunction")),e.prototype=Object.create(p),e}return c.prototype=u,f(p,"constructor",u),f(u,"constructor",c),c.displayName="GeneratorFunction",f(u,o,"GeneratorFunction"),f(p),f(p,o,"Generator"),f(p,n,function(){return this}),f(p,"toString",function(){return"[object Generator]"}),(d=function(){return{w:a,m}})()}function f(e,r,t,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}f=function(e,r,t,n){function a(r,t){f(e,r,function(e){return this._invoke(r,t,e)})}r?o?o(e,r,{value:t,enumerable:!n,configurable:!n,writable:!n}):e[r]=t:(a("next",0),a("throw",1),a("return",2))},f(e,r,t,n)}function m(e,r,t,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void t(e)}s.done?r(c):Promise.resolve(c).then(n,o)}function y(e){return function(){var r=this,t=arguments;return new Promise(function(n,o){var a=e.apply(r,t);function i(e){m(a,n,o,i,s,"next",e)}function s(e){m(a,n,o,i,s,"throw",e)}i(void 0)})}}var g=t(217),h=t(187),v=t(896).promises,b=t(928),w=function(){var e=y(d().m(function e(r){var t,n,o,a,i,s,c;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,t=b.join(__dirname,"uploads"),console.log("🗑️ DELETE DEBUG - Attempting to delete files for publicId: ".concat(r)),console.log("🗑️ DELETE DEBUG - Upload directory: ".concat(t)),n=r,[".webp",".jpg",".jpeg",".png"].some(function(e){return r.toLowerCase().endsWith(e)})&&(o=r.lastIndexOf("."),n=r.substring(0,o),console.log("🗑️ DELETE DEBUG - PublicId has extension, using base: ".concat(n))),a=["".concat(n,".webp"),"".concat(n,"_thumb.webp"),"".concat(n,".jpg"),"".concat(n,"_thumb.jpg"),"".concat(n,".jpeg"),"".concat(n,"_thumb.jpeg"),"".concat(n,".png"),"".concat(n,"_thumb.png")],console.log("🗑️ DELETE DEBUG - Checking for files: ".concat(a.join(", "))),i=0,s=a.map(function(){var e=y(d().m(function e(r){var n;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:return n=b.join(t,r),e.p=1,e.n=2,v.access(n);case 2:return e.n=3,v.unlink(n);case 3:console.log("🗑️ DELETE SUCCESS - Deleted: ".concat(r)),i++,e.n=5;break;case 4:e.p=4,e.v,console.log("🗑️ DELETE SKIP - File not found: ".concat(r));case 5:return e.a(2)}},e,null,[[1,4]])}));return function(r){return e.apply(this,arguments)}}()),e.n=1,Promise.all(s);case 1:console.log("🗑️ DELETE SUMMARY - Deleted ".concat(i," files for publicId: ").concat(r)),e.n=3;break;case 2:throw e.p=2,c=e.v,console.error("🗑️ DELETE ERROR - Failed to delete files for ".concat(r,":"),c),c;case 3:return e.a(2)}},e,null,[[0,2]])}));return function(r){return e.apply(this,arguments)}}(),E=function(){var e=y(d().m(function e(r,t){var n,o,a,i,s,c;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,"SuperAdmin"===r.userRole){e.n=1;break}return e.a(2,t.status(403).json({success:!1,error:"Access denied - SuperAdmin only"}));case 1:return e.n=2,Promise.all([g.countDocuments({_id:{$ne:r.user.id}}),g.countDocuments({role:"SuperAdmin",_id:{$ne:r.user.id}}),g.countDocuments({isActive:!0,_id:{$ne:r.user.id}})]);case 2:n=e.v,o=u(n,3),a=o[0],i=o[1],s=o[2],t.status(200).json({success:!0,data:{total:a,byRole:{SuperAdmin:i},byStatus:{active:s}}}),e.n=4;break;case 3:e.p=3,c=e.v,console.error("Error fetching user stats:",c),t.status(500).json({success:!1,error:"Failed to fetch user statistics"});case 4:return e.a(2)}},e,null,[[0,3]])}));return function(r,t){return e.apply(this,arguments)}}(),S=function(){var e=y(d().m(function e(r,t){var n,o,a,i,c,l,p,f,m,y,h,v,b,w,E;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,"SuperAdmin"===r.userRole){e.n=1;break}return e.a(2,t.status(403).json({success:!1,error:"Access denied - SuperAdmin only"}));case 1:return n=r.query,o=n.page,a=void 0===o?1:o,i=n.limit,c=void 0===i?10:i,l=n.isActive,p=n.search,(f=s({},r.queryFilters)||{})._id={$ne:r.user.id},void 0!==l&&(f.isActive="true"===l),p&&(f.$or=[{name:{$regex:p,$options:"i"}},{email:{$regex:p,$options:"i"}}]),m={createdAt:-1},y=(parseInt(a)-1)*parseInt(c),e.n=2,Promise.all([g.find(f).select("_id name email username role isActive createdAt lastLogin updatedAt updatedBy").populate("updatedBy","name username").sort(m).skip(y).limit(parseInt(c)),g.countDocuments(f)]);case 2:h=e.v,v=u(h,2),b=v[0],w=v[1],t.status(200).json({success:!0,data:{users:b,pagination:{currentPage:parseInt(a),pages:Math.ceil(w/parseInt(c)),total:w,limit:parseInt(c)}}}),e.n=4;break;case 3:e.p=3,E=e.v,console.error("Error fetching users:",E),t.status(500).json({success:!1,error:"Failed to fetch users"});case 4:return e.a(2)}},e,null,[[0,3]])}));return function(r,t){return e.apply(this,arguments)}}(),j=function(){var e=y(d().m(function e(r,t){var n,o,a;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,n=r.params.id,e.n=1,g.findById(n).select("_id name email username role isActive createdAt lastLogin updatedAt updatedBy").populate("updatedBy","name username");case 1:if(o=e.v){e.n=2;break}return e.a(2,t.status(404).json({success:!1,error:"User not found"}));case 2:t.status(200).json({success:!0,data:{user:o}}),e.n=4;break;case 3:e.p=3,a=e.v,console.error("Error fetching user:",a),t.status(500).json({success:!1,error:"Failed to fetch user"});case 4:return e.a(2)}},e,null,[[0,3]])}));return function(r,t){return e.apply(this,arguments)}}(),P=function(){var e=y(d().m(function e(r,t){var n,o,a,i,s,c,u,l,p,f,m,y;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,"SuperAdmin"===r.userRole){e.n=1;break}return e.a(2,t.status(403).json({success:!1,error:"Access denied - SuperAdmin only"}));case 1:if(n=r.body,o=n.username,a=n.email,i=n.password,s=n.name,c=n.role,"admin"===(u=void 0===c?"admin":c)||"SuperAdmin"===u){e.n=2;break}return e.a(2,t.status(400).json({success:!1,error:"Can only create admin or SuperAdmin users"}));case 2:return l=new g({username:o,email:a,password:i,name:s,role:u,isActive:!0,createdBy:r.user.id}),e.n=3,l.save({timestamps:{updatedAt:!1}});case 3:return e.n=4,g.findById(l._id).select("_id name email username role isActive createdAt lastLogin");case 4:p=e.v,t.status(201).json({success:!0,data:{user:p},message:"".concat(u," user created successfully")}),e.n=8;break;case 5:if(e.p=5,y=e.v,console.error("Error creating user:",y),11e3!==y.code){e.n=6;break}return f=Object.keys(y.keyPattern)[0],y.keyValue[f],e.a(2,t.status(400).json({success:!1,error:"User with this ".concat(f," already exists"),details:[{field:f,message:"".concat(f.charAt(0).toUpperCase()+f.slice(1)," already exists")}]}));case 6:if("ValidationError"!==y.name){e.n=7;break}return m=Object.values(y.errors).map(function(e){return e.message}),e.a(2,t.status(400).json({success:!1,error:"Validation failed",details:m}));case 7:t.status(500).json({success:!1,error:"Failed to create user"});case 8:return e.a(2)}},e,null,[[0,5]])}));return function(r,t){return e.apply(this,arguments)}}(),A=function(){var e=y(d().m(function e(r,t){var n,o,a,i,s,c,u,l;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,n=r.params.id,o=r.body,e.n=1,g.findById(n);case 1:if(a=e.v){e.n=2;break}return e.a(2,t.status(404).json({success:!1,error:"User not found"}));case 2:if(n===r.user.id.toString()){e.n=3;break}return e.a(2,t.status(403).json({success:!1,error:"Access denied - You can only update your own profile"}));case 3:return i={},["name","username","email"].forEach(function(e){void 0!==o[e]&&(i[e]=o[e])}),Object.assign(a,i),a.updatedAt=new Date,a.updatedBy=r.user.id,e.n=4,a.save();case 4:return e.n=5,g.findById(n).select("_id name email username role isActive updatedAt updatedBy").populate("updatedBy","name username");case 5:s=e.v,t.status(200).json({success:!0,data:{user:s},message:"Profile updated successfully"}),e.n=9;break;case 6:if(e.p=6,l=e.v,console.error("Error updating user profile:",l),11e3!==l.code){e.n=7;break}return c=Object.keys(l.keyPattern)[0],l.keyValue[c],e.a(2,t.status(400).json({success:!1,error:"User with this ".concat(c," already exists"),details:[{field:c,message:"".concat(c.charAt(0).toUpperCase()+c.slice(1)," already exists")}]}));case 7:if("ValidationError"!==l.name){e.n=8;break}return u=Object.values(l.errors).map(function(e){return e.message}),e.a(2,t.status(400).json({success:!1,error:"Validation failed",details:u}));case 8:t.status(500).json({success:!1,error:"Failed to update profile"});case 9:return e.a(2)}},e,null,[[0,6]])}));return function(r,t){return e.apply(this,arguments)}}(),k=function(){var e=y(d().m(function e(r,t){var n,o,a,i,s,c,u,l,p;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,n=r.params.id,o=r.body,a=o.newOwnerId,i=o.propertyIds,"SuperAdmin"===r.userRole){e.n=1;break}return e.a(2,t.status(403).json({success:!1,error:"Access denied - Only SuperAdmin can transfer property ownership"}));case 1:return e.n=2,g.findById(a);case 2:if(s=e.v){e.n=3;break}return e.a(2,t.status(404).json({success:!1,error:"New owner not found"}));case 3:return e.n=4,g.findById(n);case 4:if(c=e.v){e.n=5;break}return e.a(2,t.status(404).json({success:!1,error:"Current owner not found"}));case 5:return u={createdBy:n},i&&Array.isArray(i)&&i.length>0?u._id={$in:i}:u.approvalStatus={$in:["approved","pending"]},e.n=6,h.find(u);case 6:if(0!==e.v.length){e.n=7;break}return e.a(2,t.status(400).json({success:!1,error:"No properties found to transfer"}));case 7:return e.n=8,h.updateMany(u,{$set:{createdBy:a,updatedBy:r.user.id,updatedAt:new Date}});case 8:l=e.v,t.status(200).json({success:!0,message:"Successfully transferred ".concat(l.modifiedCount," property(ies) from ").concat(c.name," to ").concat(s.name),data:{transferredCount:l.modifiedCount,fromUser:{id:c._id,name:c.name,email:c.email},toUser:{id:s._id,name:s.name,email:s.email}}}),e.n=10;break;case 9:e.p=9,p=e.v,console.error("Error transferring property ownership:",p),t.status(500).json({success:!1,error:"Failed to transfer property ownership"});case 10:return e.a(2)}},e,null,[[0,9]])}));return function(r,t){return e.apply(this,arguments)}}(),I=function(){var e=y(d().m(function e(r,t){var n,i,s,c,u,l,p,f,m,y,v,b,E,S;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,n=r.params.id,e.n=1,g.findById(n);case 1:if(i=e.v){e.n=2;break}return e.a(2,t.status(404).json({success:!1,error:"User not found"}));case 2:if("SuperAdmin"!==i.role){e.n=3;break}return e.a(2,t.status(403).json({success:!1,error:"Cannot delete SuperAdmin user"}));case 3:if("admin"!==r.userRole){e.n=5;break}if(n===r.user.id.toString()){e.n=4;break}return e.a(2,t.status(403).json({success:!1,error:"Access denied - You can only delete your own account"}));case 4:e.n=6;break;case 5:if("SuperAdmin"!==r.userRole){e.n=6;break}if(i._id.toString()!==r.user.id.toString()){e.n=6;break}return e.a(2,t.status(403).json({success:!1,error:"SuperAdmin cannot delete their own account"}));case 6:if(s=[],c=[],u=0,"SuperAdmin"!==r.userRole){e.n=17;break}return e.n=7,h.find({createdBy:n,approvalStatus:{$in:["approved","pending"]}});case 7:if(!((s=e.v).length>0)){e.n=8;break}return console.log("Transferring ".concat(s.length," approved/pending properties to SuperAdmin")),e.n=8,h.updateMany({createdBy:n,approvalStatus:{$in:["approved","pending"]}},{$set:{createdBy:r.user.id,updatedBy:r.user.id,updatedAt:new Date}});case 8:return e.n=9,h.find({createdBy:n,approvalStatus:{$in:["not_applicable","rejected"]}});case 9:if(!((c=e.v).length>0)){e.n=17;break}console.log("Deleting ".concat(c.length," draft/rejected properties with image cleanup")),l=a(c),e.p=10,f=d().m(function e(){var r,t;return d().w(function(e){for(;;)switch(e.n){case 0:if(!((r=p.value).images&&r.images.length>0)){e.n=2;break}return console.log("🗑️ Cleaning up ".concat(r.images.length," images for property: ").concat(r.title)),t=r.images.map(function(e){return w(e.publicId).catch(function(t){console.error("Failed to delete image ".concat(e.publicId," for property ").concat(r.title,":"),t)})}),e.n=1,Promise.allSettled(t);case 1:u+=r.images.length;case 2:return e.a(2)}},e)}),l.s();case 11:if((p=l.n()).done){e.n=13;break}return e.d(o(f()),12);case 12:e.n=11;break;case 13:e.n=15;break;case 14:e.p=14,E=e.v,l.e(E);case 15:return e.p=15,l.f(),e.f(15);case 16:return console.log("🗑️ Attempted to delete ".concat(u," images from local storage")),e.n=17,h.deleteMany({createdBy:n,approvalStatus:{$in:["not_applicable","rejected"]}});case 17:return e.n=18,g.findByIdAndDelete(n);case 18:m="User deleted successfully",y={},"SuperAdmin"===r.userRole&&(v=s?s.length:0,b=c?c.length:0,(v>0||b>0)&&(y.propertyActions={},v>0&&(y.propertyActions.transferred={count:v,message:"".concat(v," approved/pending properties transferred to SuperAdmin")}),b>0&&(y.propertyActions.deleted={count:b,imagesDeleted:u,message:"".concat(b," draft/rejected properties deleted with ").concat(u," images cleaned up")}),m="User deleted successfully. ".concat(v," properties transferred, ").concat(b," properties deleted with ").concat(u," images cleaned up."))),t.status(200).json({success:!0,message:m,details:Object.keys(y).length>0?y:void 0}),e.n=20;break;case 19:e.p=19,S=e.v,console.error("Error deleting user:",S),t.status(500).json({success:!1,error:"Failed to delete user"});case 20:return e.a(2)}},e,null,[[10,14,15,16],[0,19]])}));return function(r,t){return e.apply(this,arguments)}}(),O=function(){var e=y(d().m(function e(r,t){var n,o,a,i,s;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,n=r.params.id,"boolean"==typeof(o=r.body.isActive)){e.n=1;break}return e.a(2,t.status(400).json({success:!1,error:"isActive field must be a boolean value"}));case 1:return e.n=2,g.findById(n);case 2:if(a=e.v){e.n=3;break}return e.a(2,t.status(404).json({success:!1,error:"User not found"}));case 3:if("SuperAdmin"===r.userRole){e.n=4;break}return e.a(2,t.status(403).json({success:!1,error:"Access denied - Only SuperAdmin can update user status"}));case 4:if(a._id.toString()!==r.user.id.toString()){e.n=5;break}return e.a(2,t.status(403).json({success:!1,error:"SuperAdmin cannot change their own status"}));case 5:if("SuperAdmin"!==a.role){e.n=6;break}return e.a(2,t.status(403).json({success:!1,error:"Cannot change status of other SuperAdmin users"}));case 6:return a.isActive=o,a.updatedAt=new Date,a.updatedBy=r.user.id,e.n=7,a.save();case 7:return e.n=8,g.findById(n).select("_id name email username role isActive createdAt lastLogin updatedAt updatedBy").populate("updatedBy","name username");case 8:i=e.v,t.status(200).json({success:!0,data:{user:i},message:"User ".concat(o?"activated":"deactivated"," successfully")}),e.n=10;break;case 9:e.p=9,s=e.v,console.error("Error updating user status:",s),t.status(500).json({success:!1,error:"Failed to update user status"});case 10:return e.a(2)}},e,null,[[0,9]])}));return function(r,t){return e.apply(this,arguments)}}();e.exports={getUserStats:E,getUsers:S,getUser:j,createUser:P,updateUser:A,updateUserStatus:O,deleteUser:I,transferPropertyOwnership:k}},395:(e,r,t)=>{var n=t(252).Router(),o=t(342),a=o.getAreasForEmirate,i=o.getAmenitiesForPropertyType,s=o.getAvailablePropertyTypes,c=o.getProperties,u=o.getProperty,l=o.createPropertyWithImages,p=o.createPropertyWithoutImages,d=o.updateProperty,f=o.updatePropertyWithoutImages,m=o.deleteProperty,y=o.deletePropertyImage,g=o.setMainPropertyImage,h=t(226).auth,v=t(258),b=t(902).checkPermission,w=t(110),E=(w.handlePropertyImageUpload,w.handleSmartCompressedImageUpload,w.optionalImages,w.parseMultipartData),S=w.processValidatedImages,j=t(567),P=j.createPropertyWithImagesValidation,A=j.createPropertyWithoutImagesValidation,k=j.updatePropertyValidation,I=j.propertyQueryValidation,O=j.singlePropertyValidation,T=j.parseFormDataOnly,x=(j.parsePropertyDataFromFormData,j.parseEnhancedFormData);n.get("/property-types",h,s),n.get("/amenities/:propertyType",h,i),n.get("/areas/:emirate",h,a),n.delete("/:id/images/:imageId",h,b("properties","Update"),y),n.put("/:id/images/:imageId/main",h,b("properties","Update"),g),n.get("/",v,b("properties","Read"),I,c),n.post("/",h,b("properties","Create"),E,x,P,S,l),n.post("/without-images",h,b("properties","Create"),T,A,p),n.put("/:id/without-images",h,b("properties","Update"),T,k,f),n.route("/:id").get(v,b("properties","Read"),O,u).put(h,b("properties","Update"),E,x,k,S,d).delete(h,b("properties","Delete"),O,m),e.exports=n},436:e=>{e.exports={rolePermissions:{SuperAdmin:{properties:{Create:"any",Read:"any",Update:"any",Delete:"any",Approve:"any"},users:{Create:"any",Read:"any",Update:"own",UpdateStatus:"any",Delete:"any"}},admin:{properties:{Create:"any",Read:"own",Update:"own",Delete:"rejected_or_draft"},users:{Read:"own",Update:"own"}},visitor:{properties:{Read:"published_only"}}},buildPropertyQuery:function(e){var r=(null==e?void 0:e.role)||"visitor";return"SuperAdmin"===r?{$or:[{status:{$ne:"draft"}},{status:"draft",createdBy:e.id}]}:"admin"===r?{createdBy:e.id}:{status:{$in:["available","sold","rented","pending"]}}},buildUserQuery:function(e){return"SuperAdmin"===((null==e?void 0:e.role)||"visitor")?{}:{_id:null}}}},461:e=>{"use strict";e.exports=require("multer")},525:e=>{"use strict";e.exports=require("helmet")},528:(e,r,t)=>{var n=t(572);t(818).config(),e.exports={createTransporter:function(){return n.createTransport({host:process.env.EMAIL_HOST,port:process.env.EMAIL_PORT,secure:"true"===process.env.EMAIL_SECURE,auth:{user:process.env.EMAIL_USER,pass:process.env.EMAIL_PASSWORD}})}}},531:(e,r,t)=>{function n(){var e,r,t="function"==typeof Symbol?Symbol:{},a=t.iterator||"@@iterator",i=t.toStringTag||"@@toStringTag";function s(t,n,a,i){var s=n&&n.prototype instanceof u?n:u,l=Object.create(s.prototype);return o(l,"_invoke",function(t,n,o){var a,i,s,u=0,l=o||[],p=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(r,t){return a=r,i=0,s=e,d.n=t,c}};function f(t,n){for(i=t,s=n,r=0;!p&&u&&!o&&r<l.length;r++){var o,a=l[r],f=d.p,m=a[2];t>3?(o=m===n)&&(s=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=t<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=t<3||a[0]>n||n>m)&&(a[4]=t,a[5]=n,d.n=m,i=0))}if(o||t>1)return c;throw p=!0,n}return function(o,l,m){if(u>1)throw TypeError("Generator is already running");for(p&&1===l&&f(l,m),i=l,s=m;(r=i<2?e:s)||!p;){a||(i?i<3?(i>1&&(d.n=-1),f(i,s)):d.n=s:d.v=s);try{if(u=2,a){if(i||(o="next"),r=a[o]){if(!(r=r.call(a,s)))throw TypeError("iterator result is not an object");if(!r.done)return r;s=r.value,i<2&&(i=0)}else 1===i&&(r=a.return)&&r.call(a),i<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((r=(p=d.n<0)?s:t.call(n,d))!==c)break}catch(r){a=e,i=1,s=r}finally{u=1}}return{value:r,done:p}}}(t,a,i),!0),l}var c={};function u(){}function l(){}function p(){}r=Object.getPrototypeOf;var d=[][a]?r(r([][a]())):(o(r={},a,function(){return this}),r),f=p.prototype=u.prototype=Object.create(d);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,o(e,i,"GeneratorFunction")),e.prototype=Object.create(f),e}return l.prototype=p,o(f,"constructor",p),o(p,"constructor",l),l.displayName="GeneratorFunction",o(p,i,"GeneratorFunction"),o(f),o(f,i,"Generator"),o(f,a,function(){return this}),o(f,"toString",function(){return"[object Generator]"}),(n=function(){return{w:s,m}})()}function o(e,r,t,n){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}o=function(e,r,t,n){function i(r,t){o(e,r,function(e){return this._invoke(r,t,e)})}r?a?a(e,r,{value:t,enumerable:!n,configurable:!n,writable:!n}):e[r]=t:(i("next",0),i("throw",1),i("return",2))},o(e,r,t,n)}function a(e,r,t,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void t(e)}s.done?r(c):Promise.resolve(c).then(n,o)}var i=t(37);t(250).setServers(["8.8.8.8","8.8.4.4"]);var s=function(){var e,r=(e=n().m(function e(){var r,t;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,r=process.env.DATABASE.replace("<PASSWORD>",process.env.DATABASE_PASSWORD),e.n=1,i.connect(r);case 1:e.n=3;break;case 2:e.p=2,t=e.v,console.error("❌ DB connection error:",t),process.exit(1);case 3:return e.a(2)}},e,null,[[0,2]])}),function(){var r=this,t=arguments;return new Promise(function(n,o){var i=e.apply(r,t);function s(e){a(i,n,o,s,c,"next",e)}function c(e){a(i,n,o,s,c,"throw",e)}s(void 0)})});return function(){return r.apply(this,arguments)}}();e.exports={connectDB:s,mongoose:i}},567:(e,r,t)=>{function n(e,r){return function(e){if(Array.isArray(e))return e}(e)||function(e,r){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var n,o,a,i,s=[],c=!0,u=!1;try{if(a=(t=t.call(e)).next,0===r){if(Object(t)!==t)return;c=!1}else for(;!(c=(n=a.call(t)).done)&&(s.push(n.value),s.length!==r);c=!0);}catch(e){u=!0,o=e}finally{try{if(!c&&null!=t.return&&(i=t.return(),Object(i)!==i))return}finally{if(u)throw o}}return s}}(e,r)||u(e,r)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),t.push.apply(t,n)}return t}function a(e,r,t){return(r=function(e){var r=function(e){if("object"!=y(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var t=r.call(e,"string");if("object"!=y(t))return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==y(r)?r:r+""}(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function i(e){return function(e){if(Array.isArray(e))return l(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||u(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function s(e){if(null!=e){var r=e["function"==typeof Symbol&&Symbol.iterator||"@@iterator"],t=0;if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length))return{next:function(){return e&&t>=e.length&&(e=void 0),{value:e&&e[t++],done:!e}}}}throw new TypeError(y(e)+" is not iterable")}function c(e,r){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=u(e))||r&&e&&"number"==typeof e.length){t&&(e=t);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,s=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return i=e.done,e},e:function(e){s=!0,a=e},f:function(){try{i||null==t.return||t.return()}finally{if(s)throw a}}}}function u(e,r){if(e){if("string"==typeof e)return l(e,r);var t={}.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?l(e,r):void 0}}function l(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=Array(r);t<r;t++)n[t]=e[t];return n}function p(){var e,r,t="function"==typeof Symbol?Symbol:{},n=t.iterator||"@@iterator",o=t.toStringTag||"@@toStringTag";function a(t,n,o,a){var c=n&&n.prototype instanceof s?n:s,u=Object.create(c.prototype);return d(u,"_invoke",function(t,n,o){var a,s,c,u=0,l=o||[],p=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(r,t){return a=r,s=0,c=e,d.n=t,i}};function f(t,n){for(s=t,c=n,r=0;!p&&u&&!o&&r<l.length;r++){var o,a=l[r],f=d.p,m=a[2];t>3?(o=m===n)&&(c=a[(s=a[4])?5:(s=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=t<2&&f<a[1])?(s=0,d.v=n,d.n=a[1]):f<m&&(o=t<3||a[0]>n||n>m)&&(a[4]=t,a[5]=n,d.n=m,s=0))}if(o||t>1)return i;throw p=!0,n}return function(o,l,m){if(u>1)throw TypeError("Generator is already running");for(p&&1===l&&f(l,m),s=l,c=m;(r=s<2?e:c)||!p;){a||(s?s<3?(s>1&&(d.n=-1),f(s,c)):d.n=c:d.v=c);try{if(u=2,a){if(s||(o="next"),r=a[o]){if(!(r=r.call(a,c)))throw TypeError("iterator result is not an object");if(!r.done)return r;c=r.value,s<2&&(s=0)}else 1===s&&(r=a.return)&&r.call(a),s<2&&(c=TypeError("The iterator does not provide a '"+o+"' method"),s=1);a=e}else if((r=(p=d.n<0)?c:t.call(n,d))!==i)break}catch(r){a=e,s=1,c=r}finally{u=1}}return{value:r,done:p}}}(t,o,a),!0),u}var i={};function s(){}function c(){}function u(){}r=Object.getPrototypeOf;var l=[][n]?r(r([][n]())):(d(r={},n,function(){return this}),r),f=u.prototype=s.prototype=Object.create(l);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,d(e,o,"GeneratorFunction")),e.prototype=Object.create(f),e}return c.prototype=u,d(f,"constructor",u),d(u,"constructor",c),c.displayName="GeneratorFunction",d(u,o,"GeneratorFunction"),d(f),d(f,o,"Generator"),d(f,n,function(){return this}),d(f,"toString",function(){return"[object Generator]"}),(p=function(){return{w:a,m}})()}function d(e,r,t,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}d=function(e,r,t,n){function a(r,t){d(e,r,function(e){return this._invoke(r,t,e)})}r?o?o(e,r,{value:t,enumerable:!n,configurable:!n,writable:!n}):e[r]=t:(a("next",0),a("throw",1),a("return",2))},d(e,r,t,n)}function f(e,r,t,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void t(e)}s.done?r(c):Promise.resolve(c).then(n,o)}function m(e){return function(){var r=this,t=arguments;return new Promise(function(n,o){var a=e.apply(r,t);function i(e){f(a,n,o,i,s,"next",e)}function s(e){f(a,n,o,i,s,"throw",e)}i(void 0)})}}function y(e){return y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},y(e)}var g=t(975),h=g.body,v=g.query,b=g.param,w=g.validationResult,E=t(461),S=t(989),j=S.EMIRATE_AREA_MAP,P=S.PROPERTY_TYPE_AMENITIES_MAP,A=S.PROPERTY_STATUS,k=S.EMIRATES,I=S.PROPERTY_TYPES,O=S.LISTING_TYPES,T=t(11).validateImageUrl,x=function(e,r,t){var n=w(e);if(console.log("🔍 Checking validation errors:",n.isEmpty()?"No errors":"Has errors"),!n.isEmpty()){console.log("❌ Validation errors found:",n.array());var o=n.array().map(function(e){return{field:e.path,message:e.msg,value:e.value}});return r.status(400).json({success:!1,error:"Validation failed",details:o})}console.log("✅ All validations passed"),t()},q=[h("username").custom(function(e,r){var t=r.req;if(e&&""!==e.trim()){if((e=e.trim()).length<3)throw new Error("Username must be at least 3 characters long");if(e.length>50)throw new Error("Username cannot exceed 50 characters");if(/^[a-zA-Z0-9_]+$/.test(e))return t.body.username=e,!0;throw new Error("Username can only contain letters, numbers, and underscores")}throw new Error("Username is required")}),h("password").custom(function(e,r){return r.req,_(e,"login")}),x],_=function(e){var r,t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"new";if("current"===n?(r="Current password",t="Current password cannot exceed 128 characters"):"login"===n?(r="Password",t="Password cannot exceed 128 characters"):(r="New password",t="New password cannot exceed 128 characters"),e&&""!==e.trim()){if(e.length<8)throw new Error("".concat(r," must be at least 8 characters long"));if(e.length>128)throw new Error(t);if(/(?=.*[a-z])/.test(e)){if(/(?=.*[A-Z])/.test(e)){if(/(?=.*\d)/.test(e)){if(/(?=.*[@$!%*?&])/.test(e))return!0;throw new Error("".concat(r," must contain at least one special character (@$!%*?&)"))}throw new Error("".concat(r," must contain at least one number"))}throw new Error("".concat(r," must contain at least one uppercase letter"))}throw new Error("".concat(r," must contain at least one lowercase letter"))}throw new Error("".concat(r," is required"))},R=[h("currentPassword").custom(function(e,r){return r.req,_(e,"current")}),h("newPassword").custom(function(e,r){var t=r.req;if(_(e,"new"),e===t.body.currentPassword)throw new Error("New password must be different from current password");return!0}),h("confirmPassword").custom(function(e,r){var t=r.req;if(e&&""!==e.trim()){if(e!==t.body.newPassword)throw new Error("Password do not match");return!0}throw new Error("Please confirm your new password")}),x],M=function(e,r,t){if(e.body){var n=["password","currentPassword","newPassword","confirmPassword"];Object.keys(e.body).forEach(function(r){"string"!=typeof e.body[r]||n.includes(r)?"string"==typeof e.body[r]&&(console.log("ðŸ” Trimming password field: ".concat(r)),e.body[r]=e.body[r].trim()):(e.body[r]=e.body[r].replace(/<[^>]*>/g,""),e.body[r]=e.body[r].replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,""),e.body[r]=e.body[r].replace(/javascript:/gi,""),e.body[r]=e.body[r].replace(/on\w+\s*=/gi,""),e.body[r]=e.body[r].trim())})}t()},F=function(e,r,t){if("/login"===e.path){var n=["username","password"],o=Object.keys(e.body).filter(function(e){return!n.includes(e)});if(o.length>0)return r.status(400).json({success:!1,error:"Unexpected fields in request",unexpectedFields:o})}else if("/change-password"===e.path){var a=["currentPassword","newPassword","confirmPassword"],i=Object.keys(e.body).filter(function(e){return!a.includes(e)});if(i.length>0)return r.status(400).json({success:!1,error:"Unexpected fields in request",unexpectedFields:i})}t()},B=function(e,r,t){var n;if(console.log("🚗 PARKING DEBUG - Raw request body parking data:"),console.log("Full parking object:",JSON.stringify(null===(n=e.body.details)||void 0===n?void 0:n.parking,null,2)),e.body.details&&e.body.details.parking){var o,a=e.body.details.parking;console.log("🚗 PARKING DEBUG - Individual fields:"),console.log("parking.available:",a.available,"(type:",y(a.available),")"),console.log("parking.type:",a.type,"(type:",y(a.type),")"),console.log("parking.spaces:",a.spaces,"(type:",y(a.spaces),")"),a.available?console.log("🚗 PARKING DEBUG - Parking is available, keeping all fields"):(console.log("🚗 PARKING DEBUG - Parking not available, cleaning up fields"),null!==a.type&&void 0!==a.type&&""!==a.type||(console.log("🚗 PARKING DEBUG - Removing parking.type"),delete e.body.details.parking.type),null!==a.spaces&&void 0!==a.spaces||(console.log("🚗 PARKING DEBUG - Removing parking.spaces"),delete e.body.details.parking.spaces)),console.log("🚗 PARKING DEBUG - After cleanup:"),console.log("Final parking object:",JSON.stringify(null===(o=e.body.details)||void 0===o?void 0:o.parking,null,2))}else console.log("🚗 PARKING DEBUG - No parking data found in request");t()},D=[h("title").custom(function(e,r){var t=r.req;if(""===e)throw new Error("Property title is required");if((e=e.trim()).length<5)throw new Error("Title must be at least 5 characters long");if(e.length>200)throw new Error("Title cannot exceed 200 characters");if(!/[a-zA-Z]/.test(e))throw new Error("Title must contain at least some letters");return t.body.title=e,!0}).custom(function(){var e=m(p().m(function e(r,n){var o,a,i,s;return p().w(function(e){for(;;)switch(e.n){case 0:return o=n.req,a=t(187),i=o.params.id,s={title:r},i&&(i.match(/^[0-9a-fA-F]{24}$/)?s._id={$ne:i}:s.slug={$ne:i}),e.n=1,a.findOne(s);case 1:if(!e.v){e.n=2;break}throw new Error("A property with this title already exists. Please use a unique title.");case 2:return e.a(2,!0)}},e)}));return function(r,t){return e.apply(this,arguments)}}()),h("description").custom(function(e,r){var t=r.req;if(""===e)throw new Error("Property description is required");if((e=e.trim()).length<200)throw new Error("Description must be at least 200 characters long");if(e.length>1e4)throw new Error("Description cannot exceed 10000 characters");return t.body.description=e,!0}),h("propertyType").custom(function(e,r){if(r.req,""==e)throw new Error("Property type is required");if("string"!=typeof e)throw new Error("Property type must be a string");if(!/^[a-zA-Z0-9\s-]+$/.test(e)||e.trim()!==e||e.includes("  "))throw new Error('Invalid property type format: "'.concat(e,'". Must contain only letters, numbers, spaces, and hyphens, with no leading/trailing spaces.'));return!0}),h("price").optional().custom(function(e,r){var t=r.req;if("off plan"===t.body.listingType)return!0;if(null!=e&&""!==e){var n=parseFloat(e);if(isNaN(n)||n<=0)throw new Error("Price must be a positive number");t.body.price=n}return!0}),h("location.address").custom(function(e,r){var t=r.req;if(!e||""===e.trim())throw new Error("Address is required");if((e=e.trim()).length<5)throw new Error("Address must be at least 5 characters long");if(e.length>200)throw new Error("Address cannot exceed 200 characters");return t.body.location.address=e,!0}),h("location.emirate").notEmpty().withMessage("Emirate is required"),h("location.area").custom(function(e,r){var t,n=r.req;if(""===e)throw new Error("Location area is required");if(!(null===(t=n.body.location)||void 0===t?void 0:t.emirate))throw new Error("Emirate must be selected before area");return!0}),h("details.bedrooms").optional().custom(function(e,r){var t=r.req.body.propertyType;if("studio"===t||"office"===t){if(null!=e&&""!==e)throw new Error("Bedrooms field is not applicable for ".concat(t," property type. Please remove this field."));return!0}if(null!=e&&""!==e&&(!Number.isInteger(Number(e))||Number(e)<0))throw new Error("Bedrooms must be a non-negative integer");return!0}),h("details.bathrooms").optional().custom(function(e,r){var t=r.req;if(null!=e&&""!==e){var n=parseInt(e);if(isNaN(n)||n<0||!Number.isInteger(Number(e)))throw new Error("Bathrooms must be a non-negative integer");t.body.details.bathrooms=n}return!0}),h("details.area").optional().custom(function(e,r){var t=r.req;if(null!=e&&""!==e){var n=parseFloat(e);if(isNaN(n)||n<=0)throw new Error("Property area must be a positive number");if(n>5e4)throw new Error("Property area cannot exceed 50,000 square feet");t.body.details.area=n}return!0}),h("details.totalFloors").custom(function(e,r){if(r.req,null==e)return!0;if(!Number.isInteger(Number(e))||Number(e)<=0)throw new Error("Total floors must be a positive integer greater than 0");return!0}),h("details.floorLevel").custom(function(e,r){var t=r.req.body.propertyType;if("villa"===t||"townhouse"===t){if(void 0!==e&&""!==e)throw new Error("Floor level field is not applicable for ".concat(t," property type. Please remove this field."));return!0}return!0}),h("details.landArea").custom(function(e,r){var t=r.req,n=t.body.propertyType;if("apartment"===n||"penthouse"===n||"studio"===n){if(null!=e&&""!==e)throw new Error("Land area field is not applicable for ".concat(n," property type. Please remove this field."));return!0}if(null==e||""===e)return!0;var o=parseFloat(e);if(isNaN(o)||o<0)throw new Error("Land area must be a positive number");return t.body.details.landArea=o,!0}),h("details.yearBuilt").custom(function(e){if(null===e||""===e||void 0===e)return!0;var r=(new Date).getFullYear()+2;if(!Number.isInteger(Number(e))||Number(e)<1990||Number(e)>r)throw new Error("Year built must be between ".concat(1990," and ").concat(r));return!0}),h("amenities").optional({nullable:!0,checkFalsy:!0}).if(h("amenities").exists()).isArray().withMessage("Amenities must be an array").custom(function(){var e=m(p().m(function e(r,t){var n,o,a,i,u,l,d,f,m,y,g,h,v,b;return p().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.req,r&&Array.isArray(r)){e.n=1;break}return e.a(2,!0);case 1:if(!(r.length>50)){e.n=2;break}throw new Error("Cannot have more than 50 amenities");case 2:if(Array.from(new Set(r)).length===r.length){e.n=3;break}throw new Error("Duplicate amenities are not allowed");case 3:o=c(r),e.p=4,o.s();case 5:if((a=o.n()).done){e.n=8;break}if("string"==typeof(i=a.value)){e.n=6;break}throw new Error("Amenity must be a string: ".concat(i));case 6:if(/^[a-zA-Z0-9\s-]{2,50}$/.test(i)&&i.trim()===i&&!i.includes("  ")){e.n=7;break}throw new Error('Invalid amenity format: "'.concat(i,'". Must be 2-50 characters, contain only letters, numbers, spaces, and hyphens, with no leading/trailing spaces.'));case 7:e.n=5;break;case 8:e.n=10;break;case 9:e.p=9,v=e.v,o.e(v);case 10:return e.p=10,o.f(),e.f(10);case 11:if(!(u=n.body.propertyType)){e.n=19;break}l=P[u],d=new Set,Object.values(P).forEach(function(e){e.forEach(function(e){d.add(e.toLowerCase())})}),f=[],m=c(r),e.p=12,g=p().m(function e(){var r;return p().w(function(e){for(;;)switch(e.n){case 0:r=y.value,d.has(r.toLowerCase())&&l&&l.some(function(e){return e.toLowerCase()===r.toLowerCase()})||f.push(r);case 1:return e.a(2)}},e)}),m.s();case 13:if((y=m.n()).done){e.n=15;break}return e.d(s(g()),14);case 14:e.n=13;break;case 15:e.n=17;break;case 16:e.p=16,b=e.v,m.e(b);case 17:return e.p=17,m.f(),e.f(17);case 18:f.length>0&&(h="The following custom amenities are being used for property type ".concat(u,": ").concat(f.join(", "),". These are not in the predefined list but will be accepted."),n.validationWarnings||(n.validationWarnings=[]),n.validationWarnings.push({type:"custom_amenities",message:h,customAmenities:f}));case 19:return e.a(2,!0)}},e,null,[[12,16,17,18],[4,9,10,11]])}));return function(r,t){return e.apply(this,arguments)}}()),h("images").custom(function(e,r){var t=r.req,n=t.files&&t.files.length>0,o=e&&Array.isArray(e)&&e.length>0;if(!n&&!o)throw new Error("At least one image is required");if(n&&!o)return!0;if(e.length>10)throw new Error("Must have between 1 and 10 images");for(var a=0,s=[],c=[],u=[],l=0;l<e.length;l++){var p=e[l],d=l+1;if(!p.url)throw new Error("Image ".concat(d,": URL is required"));if(!p.publicId)throw new Error("Image ".concat(d,": Public ID is required"));if(!/^https?:\/\/.+(\.(jpg|jpeg|png|webp)|\/[^\/]+)$/i.test(p.url)&&!T(p.url))throw new Error("Image ".concat(d,": URL must be a valid HTTP/HTTPS URL ending with jpg, jpeg, png, webp, or a valid local upload URL"));if(p.publicId.length>100)throw new Error("Image ".concat(d,": Public ID cannot exceed 100 characters"));if(void 0!==p.order){if(!Number.isInteger(p.order)||p.order<0||p.order>10)throw new Error("Image ".concat(d,": Order must be an integer between 0 and 10"));s.push(p.order)}if(!0===p.isMain&&a++,c.includes(p.url))throw new Error("Image ".concat(d,": Duplicate image URL found"));if(c.push(p.url),u.includes(p.publicId))throw new Error("Image ".concat(d,": Duplicate public ID found"));if(u.push(p.publicId),p.altText&&p.altText.trim()!==p.altText)throw new Error("Image ".concat(d,": Alt text cannot have leading or trailing spaces"));if(!/^[a-zA-Z0-9_\-\/]+$/.test(p.publicId))throw new Error("Image ".concat(d,": Public ID can only contain letters, numbers, underscores, hyphens, and forward slashes"))}if(a>1)throw new Error("Only one image can be marked as main image");0===a&&e.length;var f=s.filter(function(e){return e>0}),m=i(new Set(f));if(f.length!==m.length)throw new Error("Duplicate image orders are not allowed (except for order 0)");return!0}),h("listingType").custom(function(e,r){var t=r.req;if(!e)throw new Error("Listing type is required");var n=t.body.status;if("sold"===n&&"sale"!==e)throw new Error("Only 'sale' properties can have 'sold' status");if("rented"===n&&"rent"!==e)throw new Error("Only 'rent' properties can have 'rented' status");return!0}),h("details.parking.type").custom(function(e,r){var t,n=null===(t=r.req.body.details)||void 0===t||null===(t=t.parking)||void 0===t?void 0:t.available,o=!0===n||"true"===n;if(o&&(!e||""===e.trim()))throw new Error("Parking type is required when parking is available");if(!o&&e&&""!==e.trim())throw new Error("Parking type should not be specified when parking is not available");return!0}),h("details.parking.spaces").custom(function(e,r){var t,n=null===(t=r.req.body.details)||void 0===t||null===(t=t.parking)||void 0===t?void 0:t.available,o=!0===n||"true"===n;if(o){if(null==e||""===e)throw new Error("Number of parking spaces is required when parking is available");var a=parseInt(e);if(isNaN(a)||a<=0)throw new Error("Number of parking spaces must be greater than 0 when parking is available")}else if(!o&&e&&"0"!==e&&0!==e)throw new Error("Parking spaces should not be specified when parking is not available");return!0}),h("status").custom(function(e,r){if(r.req,e){var t=["draft","available"];if(!t.includes(e))throw new Error("Invalid status for property creation. Only '".concat(t.join("' or '"),"' are allowed when creating a new property."))}return!0}),B,x],N=[h("title").custom(function(e,r){var t=r.req;if(""===e)throw new Error("Property title is required");if((e=e.trim()).length<5)throw new Error("Title must be at least 5 characters long");if(e.length>200)throw new Error("Title cannot exceed 200 characters");if(!/[a-zA-Z]/.test(e))throw new Error("Title must contain at least some letters");return t.body.title=e,!0}).custom(function(){var e=m(p().m(function e(r,n){var o,a,i,s;return p().w(function(e){for(;;)switch(e.n){case 0:return o=n.req,a=t(187),i=o.params.id,s={title:r},i&&(i.match(/^[0-9a-fA-F]{24}$/)?s._id={$ne:i}:s.slug={$ne:i}),e.n=1,a.findOne(s);case 1:if(!e.v){e.n=2;break}throw new Error("A property with this title already exists. Please use a unique title.");case 2:return e.a(2,!0)}},e)}));return function(r,t){return e.apply(this,arguments)}}()),h("description").custom(function(e,r){var t=r.req;if(""===e)throw new Error("Property description is required");if((e=e.trim()).length<200)throw new Error("Description must be at least 200 characters long");if(e.length>1e4)throw new Error("Description cannot exceed 10000 characters");return t.body.description=e,!0}),h("propertyType").custom(function(e,r){if(r.req,""==e)throw new Error("Property type is required");if("string"!=typeof e)throw new Error("Property type must be a string");if(!/^[a-zA-Z0-9\s-]+$/.test(e)||e.trim()!==e||e.includes("  "))throw new Error('Invalid property type format: "'.concat(e,'". Must contain only letters, numbers, spaces, and hyphens, with no leading/trailing spaces.'));return!0}),h("price").optional().custom(function(e,r){var t=r.req;if("off plan"===t.body.listingType)return!0;if(null!=e&&""!==e){var n=parseFloat(e);if(isNaN(n)||n<=0)throw new Error("Price must be a positive number");t.body.price=n}return!0}),h("location.address").custom(function(e,r){var t=r.req;if(!e||""===e.trim())throw new Error("Address is required");if((e=e.trim()).length<5)throw new Error("Address must be at least 5 characters long");if(e.length>200)throw new Error("Address cannot exceed 200 characters");return t.body.location.address=e,!0}),h("location.emirate").optional().custom(function(){var e=m(p().m(function e(r,n){var o,a,i,s,c,u,l,d;return p().w(function(e){for(;;)switch(e.p=e.n){case 0:if(a=n.req,r){e.n=1;break}return e.a(2,!0);case 1:if(j[r]){e.n=2;break}throw new Error("Invalid emirate: ".concat(r));case 2:if(i=null===(o=a.body.location)||void 0===o?void 0:o.area,console.log("=== EMIRATE VALIDATION DEBUG ==="),console.log("Received area:",i,"(type:",y(i),")"),console.log("Received emirate:",r),i||!a.params.id){e.n=10;break}if(e.p=3,c=t(187),!a.params.id.match(/^[0-9a-fA-F]{24}$/)){e.n=5;break}return e.n=4,c.findById(a.params.id);case 4:u=e.v,e.n=7;break;case 5:return e.n=6,c.findOne({slug:a.params.id});case 6:u=e.v;case 7:if(!u||null===(s=u.location)||void 0===s||!s.area){e.n=8;break}if(i=u.location.area,(null===(l=u.location)||void 0===l?void 0:l.emirate)===r){e.n=8;break}if(j[r].some(function(e){return e.toLowerCase()===i.toLowerCase()})){e.n=8;break}throw new Error('Cannot change emirate to "'.concat(r,'" because the current area "').concat(i,'" is not valid for this emirate. Please select a valid area for ').concat(r,"."));case 8:e.n=10;break;case 9:return e.p=9,d=e.v,console.error("Error fetching existing property for emirate validation:",d),e.a(2,!0);case 10:if(!i){e.n=11;break}if(j[r].some(function(e){return e.toLowerCase()===i.toLowerCase()})){e.n=11;break}throw new Error('Area "'.concat(i,'" is not valid for emirate "').concat(r,'". Please select a valid area.'));case 11:return e.a(2,!0)}},e,null,[[3,9]])}));return function(r,t){return e.apply(this,arguments)}}()),h("location.area").custom(function(){var e=m(p().m(function e(r,n){var o,a,i,s,c,u,l,d;return p().w(function(e){for(;;)switch(e.p=e.n){case 0:if(a=n.req,""!==r){e.n=1;break}throw new Error("Location area is required");case 1:if(r){e.n=2;break}return e.a(2,!0);case 2:if((i=null===(o=a.body.location)||void 0===o?void 0:o.emirate)||!a.params.id){e.n=9;break}if(e.p=3,c=t(187),!a.params.id.match(/^[0-9a-fA-F]{24}$/)){e.n=5;break}return e.n=4,c.findById(a.params.id);case 4:u=e.v,e.n=7;break;case 5:return e.n=6,c.findOne({slug:a.params.id});case 6:u=e.v;case 7:u&&null!==(s=u.location)&&void 0!==s&&s.emirate&&(i=u.location.emirate),e.n=9;break;case 8:return e.p=8,d=e.v,console.error("Error fetching existing property for area validation:",d),e.a(2,!0);case 9:if(i){e.n=10;break}throw new Error("Emirate must be selected before area");case 10:if(l=j[i]){e.n=11;break}throw new Error("Invalid emirate: ".concat(i));case 11:if(l.some(function(e){return e.toLowerCase()===r.toLowerCase()})){e.n=12;break}throw new Error('Area "'.concat(r,'" is not valid for emirate "').concat(i,'".'));case 12:return e.a(2,!0)}},e,null,[[3,8]])}));return function(r,t){return e.apply(this,arguments)}}()),h("details.bedrooms").optional().custom(function(e,r){var t=r.req.body.propertyType;if("studio"===t||"office"===t){if(null!=e&&""!==e)throw new Error("Bedrooms field is not applicable for ".concat(t," property type. Please remove this field."));return!0}if(null!=e&&""!==e&&(!Number.isInteger(Number(e))||Number(e)<0))throw new Error("Bedrooms must be a non-negative integer");return!0}),h("details.bathrooms").optional().custom(function(e,r){var t=r.req;if(null!=e&&""!==e){var n=parseInt(e);if(isNaN(n)||n<0||!Number.isInteger(Number(e)))throw new Error("Bathrooms must be a non-negative integer");t.body.details.bathrooms=n}return!0}),h("details.area").optional().custom(function(e,r){var t=r.req;if(null!=e&&""!==e){var n=parseFloat(e);if(isNaN(n)||n<=0)throw new Error("Property area must be a positive number");if(n>5e4)throw new Error("Property area cannot exceed 50,000 square feet");t.body.details.area=n}return!0}),h("details.totalFloors").custom(function(e,r){if(r.req,""===e||null==e)return!0;if(!Number.isInteger(Number(e))||Number(e)<=0)throw new Error("Total floors must be a positive integer greater than 0");return!0}),h("details.floorLevel").custom(function(e,r){var t=r.req.body.propertyType;if("villa"===t||"townhouse"===t){if(""!==e&&null!=e)throw new Error("Floor level field is not applicable for ".concat(t," property type. Please remove this field."));return!0}return!0}),h("details.landArea").custom(function(e,r){var t=r.req,n=t.body.propertyType;if("apartment"===n||"penthouse"===n||"studio"===n){if(""!==e&&null!=e)throw new Error("Land area field is not applicable for ".concat(n," property type. Please remove this field."));return!0}if(""===e||null==e)return!0;var o=parseFloat(e);if(isNaN(o)||o<0)throw new Error("Land area must be a positive number");return t.body.details.landArea=o,!0}),h("details.yearBuilt").custom(function(e){if(null===e||""===e||void 0===e)return!0;var r=(new Date).getFullYear()+2;if(!Number.isInteger(Number(e))||Number(e)<1990||Number(e)>r)throw new Error("Year built must be between ".concat(1990," and ").concat(r));return!0}),h("amenities").optional({nullable:!0,checkFalsy:!0}).if(h("amenities").exists()).isArray().withMessage("Amenities must be an array").custom(function(e,r){if(r.req,!e||!Array.isArray(e))return!0;if(e.length>50)throw new Error("Cannot have more than 50 amenities");if(Array.from(new Set(e)).length!==e.length)throw new Error("Duplicate amenities are not allowed");var t,n=c(e);try{for(n.s();!(t=n.n()).done;){var o=t.value;if("string"!=typeof o)throw new Error("Amenity must be a string: ".concat(o));if(!/^[a-zA-Z0-9\s-]{2,50}$/.test(o)||o.trim()!==o||o.includes("  "))throw new Error('Invalid amenity format: "'.concat(o,'". Must be 2-50 characters, contain only letters, numbers, spaces, and hyphens, with no leading/trailing spaces.'))}}catch(e){n.e(e)}finally{n.f()}return!0}),h("images").custom(function(e,r){var t=r.req,n=0;if(console.log("🔍 IMAGE VALIDATION DEBUG:"),console.log("- req.body.existingImages:",t.body.existingImages),console.log("- req.uploadedImages:",t.uploadedImages?t.uploadedImages.length:"undefined"),console.log("- req.files:",t.files?t.files.length:"undefined"),console.log("- images parameter:",e?e.length:e),t.body.existingImages)try{var o=JSON.parse(t.body.existingImages);Array.isArray(o)&&(n+=o.length,console.log("- Existing images count:",o.length))}catch(e){throw new Error("Invalid existing images format")}if(t.uploadedImages&&Array.isArray(t.uploadedImages)?(n+=t.uploadedImages.length,console.log("- Uploaded images count:",t.uploadedImages.length)):t.files&&Array.isArray(t.files)&&(n+=t.files.length,console.log("- Raw files count:",t.files.length)),console.log("- Total images:",n),void 0!==e){if(0===e.length)return!0;n=e.length}else if(0===n)return!0;if(void 0===e){if(n>10)throw new Error("Cannot have more than 10 images per property");return!0}if(0===e.length)return!0;if(e.length>10)throw new Error("Must have between 1 and 10 images");for(var a=0,s=[],c=[],u=[],l=0;l<e.length;l++){var p=e[l],d=l+1;if(!p.url)throw new Error("Image ".concat(d,": URL is required"));if(!p.publicId)throw new Error("Image ".concat(d,": Public ID is required"));if(!/^https?:\/\/.+(\.(jpg|jpeg|png|webp)|\/[^\/]+)$/i.test(p.url)&&!T(p.url))throw new Error("Image ".concat(d,": URL must be a valid HTTP/HTTPS URL ending with jpg, jpeg, png, webp, or a valid local upload URL"));if(p.publicId.length>100)throw new Error("Image ".concat(d,": Public ID cannot exceed 100 characters"));if(void 0!==p.order){if(!Number.isInteger(p.order)||p.order<0||p.order>10)throw new Error("Image ".concat(d,": Order must be an integer between 0 and 10"));s.push(p.order)}if(!0===p.isMain&&a++,c.includes(p.url))throw new Error("Image ".concat(d,": Duplicate image URL found"));if(c.push(p.url),u.includes(p.publicId))throw new Error("Image ".concat(d,": Duplicate public ID found"));if(u.push(p.publicId),p.altText&&p.altText.trim()!==p.altText)throw new Error("Image ".concat(d,": Alt text cannot have leading or trailing spaces"));if(!/^[a-zA-Z0-9_\-\/]+$/.test(p.publicId))throw new Error("Image ".concat(d,": Public ID can only contain letters, numbers, underscores, hyphens, and forward slashes"))}if(a>1)throw new Error("Only one image can be marked as main image");0===a&&e.length;var f=s.filter(function(e){return e>0}),m=i(new Set(f));if(f.length!==m.length)throw new Error("Duplicate image orders are not allowed (except for order 0)");return!0}),h("listingType").custom(function(e,r){var t=r.req;if(!e)throw new Error("Listing type is required");var n=t.body.status;if("sold"===n&&"sale"!==e)throw new Error("Only 'sale' properties can have 'sold' status");if("rented"===n&&"rent"!==e)throw new Error("Only 'rent' properties can have 'rented' status");return!0}),h("details.parking.type").custom(function(e,r){var t,n=null===(t=r.req.body.details)||void 0===t||null===(t=t.parking)||void 0===t?void 0:t.available,o=!0===n||"true"===n;if(o&&(!e||""===e.trim()))throw new Error("Parking type is required when parking is available");if(!o&&e&&""!==e.trim())throw new Error("Parking type should not be specified when parking is not available");return!0}),h("details.parking.spaces").custom(function(e,r){var t,n=null===(t=r.req.body.details)||void 0===t||null===(t=t.parking)||void 0===t?void 0:t.available,o=!0===n||"true"===n;if(o){if(null==e||""===e)throw new Error("Number of parking spaces is required when parking is available");var a=parseInt(e);if(isNaN(a)||a<=0)throw new Error("Number of parking spaces must be greater than 0 when parking is available")}else if(!o&&e&&"0"!==e&&0!==e)throw new Error("Parking spaces should not be specified when parking is not available");return!0}),h().custom(function(){var e=m(p().m(function e(r,n){var o,a,i,u,l,d,f,m,y,g,h,v,b,w,E;return p().w(function(e){for(;;)switch(e.p=e.n){case 0:if(o=n.req,a=o.body,i=a.propertyType,u=a.amenities,i||!o.params.id){e.n=7;break}if(e.p=1,l=t(187),!o.params.id.match(/^[0-9a-fA-F]{24}$/)){e.n=3;break}return e.n=2,l.findById(o.params.id);case 2:d=e.v,e.n=5;break;case 3:return e.n=4,l.findOne({slug:o.params.id});case 4:d=e.v;case 5:d&&(i=d.propertyType),e.n=7;break;case 6:e.p=6,w=e.v,console.error("Error fetching existing property for amenities validation:",w);case 7:if(!(i&&u&&Array.isArray(u)&&u.length>0)){e.n=15;break}f=P[i],m=new Set,Object.values(P).forEach(function(e){e.forEach(function(e){m.add(e.toLowerCase())})}),y=[],g=c(u),e.p=8,v=p().m(function e(){var r;return p().w(function(e){for(;;)switch(e.n){case 0:r=h.value,m.has(r.toLowerCase())&&f&&f.some(function(e){return e.toLowerCase()===r.toLowerCase()})||y.push(r);case 1:return e.a(2)}},e)}),g.s();case 9:if((h=g.n()).done){e.n=11;break}return e.d(s(v()),10);case 10:e.n=9;break;case 11:e.n=13;break;case 12:e.p=12,E=e.v,g.e(E);case 13:return e.p=13,g.f(),e.f(13);case 14:y.length>0&&(b="The following custom amenities are being used for property type ".concat(i,": ").concat(y.join(", "),". These are not in the predefined list but will be accepted."),o.validationWarnings||(o.validationWarnings=[]),o.validationWarnings.push({type:"custom_amenities",message:b,customAmenities:y}));case 15:return e.a(2,!0)}},e,null,[[8,12,13,14],[1,6]])}));return function(r,t){return e.apply(this,arguments)}}()),h("status").optional().custom(function(e,r){if(r.req,e&&!A.includes(e))throw new Error("Invalid status value: '".concat(e,"'. Valid statuses are: ").concat(A.join(", ")));return!0}),B,x],U=[v("page").optional().isInt({min:1}).withMessage("Page must be greater than 1"),v("limit").optional().isInt({min:10,max:30}).withMessage("Limit must be between 10 and 30"),v("status").optional().isIn(A).withMessage("Invalid status"),v("emirate").optional().isIn(k).withMessage("Invalid emirate"),v("area").optional().custom(function(e,r){var t=r.req;if(e&&!t.query.emirate)throw new Error("Emirate must be specified when filtering by area");if(e&&t.query.emirate){var n=j[t.query.emirate];if(!n||!n.includes(e))throw new Error('Invalid area "'.concat(e,'" for emirate "').concat(t.query.emirate,'"'))}return!0}),v("propertyType").optional().isIn(I).withMessage("Invalid property type"),v("listingType").optional().isIn(O).withMessage("Invalid listing type"),v("minPrice").optional().isFloat({min:0}).withMessage("Min price must be a positive number"),v("maxPrice").optional().isFloat({min:0}).withMessage("Max price must be a positive number").custom(function(e,r){var t=r.req;if(t.query.minPrice&&parseFloat(e)<parseFloat(t.query.minPrice))throw new Error("Max price cannot be less than min price");return!0}),v("bedrooms").optional().isInt({min:0,max:20}).withMessage("Bedrooms must be between 0 and 20"),v("sortBy").optional().isIn(["price","createdAt","updatedAt","title","featured","details.area","details.bedrooms"]).withMessage("Invalid sort field. Valid options: price, createdAt, updatedAt, title, featured, details.area, details.bedrooms"),v("sortOrder").optional().isIn(["asc","desc"]).withMessage("Sort order must be 'asc' or 'desc'"),x],C=[b("id").custom(function(e){if(e.match(/^[0-9a-fA-F]{24}$/))return!0;if(e.match(/^[a-z0-9-]+$/))return!0;throw new Error("Invalid property ID or slug format")}),x],G=E().any(),L=[M,F].concat(q),$=[M,F].concat(R),z=[M].concat(D),V=[h("title").custom(function(e,r){if(r.req,!e||""===e.trim())throw new Error("Title is required");if(e.length<10)throw new Error("Title must be at least 10 characters long");if(e.length>100)throw new Error("Title must not exceed 100 characters");return!0}).custom(function(){var e=m(p().m(function e(r,n){var o;return p().w(function(e){for(;;)switch(e.n){case 0:return n.req,o=t(187),e.n=1,o.findOne({title:{$regex:new RegExp("^".concat(r,"$"),"i")}});case 1:if(!e.v){e.n=2;break}throw new Error("A property with this title already exists");case 2:return e.a(2,!0)}},e)}));return function(r,t){return e.apply(this,arguments)}}()),h("description").custom(function(e,r){if(r.req,!e||""===e.trim())throw new Error("Description is required");if(e.length<50)throw new Error("Description must be at least 50 characters long");return!0}),h("propertyType").custom(function(e,r){if(r.req,!e)throw new Error("Property type is required");if(!I.includes(e))throw new Error("Invalid property type. Must be one of: ".concat(I.join(", ")));return!0}),h("location.address").custom(function(e,r){if(r.req,!e||""===e.trim())throw new Error("Address is required");if(e.length<10)throw new Error("Address must be at least 10 characters long");if(e.length>200)throw new Error("Address must not exceed 200 characters");return!0}),h("location.emirate").notEmpty().withMessage("Emirate is required"),h("location.area").custom(function(e,r){if(r.req,!e||""===e.trim())throw new Error("Area is required");return!0}),h("details.totalFloors").custom(function(e,r){if(r.req,null!=e&&(!Number.isInteger(e)||e<1||e>200))throw new Error("Total floors must be an integer between 1 and 200");return!0}),h("details.floorLevel").custom(function(e,r){if(r.req,null!=e&&(!Number.isInteger(e)||e<-10||e>200))throw new Error("Floor level must be an integer between -10 and 200");return!0}),h("details.landArea").custom(function(e,r){if(r.req,null!=e&&("number"!=typeof e||e<=0||e>1e6))throw new Error("Land area must be a positive number not exceeding 1,000,000");return!0}),h("details.yearBuilt").custom(function(e){if(null!=e){var r=(new Date).getFullYear();if(!Number.isInteger(e)||e<1800||e>r+5)throw new Error("Year built must be between 1800 and ".concat(r+5))}return!0}),h("amenities").optional({nullable:!0,checkFalsy:!0}).if(h("amenities").exists()).isArray().withMessage("Amenities must be an array").custom(function(){var e=m(p().m(function e(r,t){var n,o,a,i,s,u,l;return p().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.req,!(r&&r.length>0)){e.n=9;break}if(o=n.body.propertyType){e.n=1;break}throw new Error("Property type is required to validate amenities");case 1:if(a=P[o]){e.n=2;break}throw new Error("Invalid property type for amenities validation");case 2:i=c(r),e.p=3,i.s();case 4:if((s=i.n()).done){e.n=6;break}if(u=s.value,a.includes(u)){e.n=5;break}throw new Error("Invalid amenity '".concat(u,"' for property type '").concat(o,"'"));case 5:e.n=4;break;case 6:e.n=8;break;case 7:e.p=7,l=e.v,i.e(l);case 8:return e.p=8,i.f(),e.f(8);case 9:return e.a(2,!0)}},e,null,[[3,7,8,9]])}));return function(r,t){return e.apply(this,arguments)}}()),h("listingType").custom(function(e,r){if(r.req,!e)throw new Error("Listing type is required");if(!O.includes(e))throw new Error("Invalid listing type");return!0}),h("details.parking.type").custom(function(e,r){if(r.req,null!=e&&!["covered","open","none"].includes(e))throw new Error("Parking type must be 'covered', 'open', or 'none'");return!0}),h("details.parking.spaces").custom(function(e,r){if(r.req,null!=e&&(!Number.isInteger(e)||e<0||e>20))throw new Error("Parking spaces must be an integer between 0 and 20");return!0}),h("status").custom(function(e,r){if(r.req,null!=e&&!A.includes(e))throw new Error("Invalid status");return!0}),h("images").custom(function(e,r){if(r.req,null==e)return!0;if(!Array.isArray(e))throw new Error("Images must be an array");if(0===e.length)return!0;if(e.length>10)throw new Error("Cannot have more than 10 images");return!0}),B,x],W=[M].concat(V),Y=[M].concat(C,N),K=[].concat(U),J=[].concat(C),H=function(){var e=m(p().m(function e(r,n){var o,a,i,s,c,u=arguments;return p().w(function(e){for(;;)switch(e.n){case 0:if(o=n.req,i=u.length>3&&void 0!==u[3]?u[3]:null,!(a=!(u.length>2&&void 0!==u[2])||u[2])||r&&""!==r.trim()){e.n=1;break}throw new Error("Username is required");case 1:if(a||null!=r){e.n=2;break}return e.a(2,!0);case 2:if(""!==r.trim()){e.n=3;break}throw new Error("Username cannot be empty");case 3:if(!((r=r.trim()).length<3)){e.n=4;break}throw new Error("Username must be at least 3 characters long");case 4:if(!(r.length>50)){e.n=5;break}throw new Error("Username cannot exceed 50 characters");case 5:if(/^[a-zA-Z0-9_]+$/.test(r)){e.n=6;break}throw new Error("Username can only contain letters, numbers, and underscores");case 6:if(!i){e.n=8;break}return s=t(217),c={username:r,_id:{$ne:i}},e.n=7,s.findOne(c);case 7:if(!e.v){e.n=8;break}throw new Error("Username already exists");case 8:return o.body.username=r,e.a(2,!0)}},e)}));return function(r,t){return e.apply(this,arguments)}}(),Q=function(){var e=m(p().m(function e(r,n){var o,a,i,s,c,u=arguments;return p().w(function(e){for(;;)switch(e.n){case 0:if(o=n.req,i=u.length>3&&void 0!==u[3]?u[3]:null,!(a=!(u.length>2&&void 0!==u[2])||u[2])||r&&""!==r.trim()){e.n=1;break}throw new Error("Email is required");case 1:if(a||null!=r){e.n=2;break}return e.a(2,!0);case 2:if(""!==r.trim()){e.n=3;break}throw new Error("Email cannot be empty");case 3:if(r=r.trim().toLowerCase(),/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r)){e.n=4;break}throw new Error("Must be a valid email address");case 4:if(!(r.length>254)){e.n=5;break}throw new Error("Email address cannot exceed 254 characters");case 5:if(!(r.includes("..")||r.startsWith(".")||r.endsWith("."))){e.n=6;break}throw new Error("Email address format is invalid");case 6:if(!i){e.n=8;break}return s=t(217),c={email:r,_id:{$ne:i}},e.n=7,s.findOne(c);case 7:if(!e.v){e.n=8;break}throw new Error("Email already exists");case 8:return o.body.email=r,e.a(2,!0)}},e)}));return function(r,t){return e.apply(this,arguments)}}(),Z=function(e,r){var t=r.req,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(n&&(!e||""===e.trim()))throw new Error("FullName is required");if(!n&&null==e)return!0;if(""===e.trim())throw new Error("FullName cannot be empty");if((e=e.trim()).length<5)throw new Error("FullName must be at least 5 characters long");if(e.length>100)throw new Error("FullName cannot exceed 100 characters");if(!/^[a-zA-Z\s'-]+$/.test(e))throw new Error("FullName can only contain letters, spaces, hyphens, and apostrophes");if(!/[a-zA-Z]/.test(e))throw new Error("FullName must contain at least some letters");if(e.includes("  ")||e.startsWith(" ")||e.endsWith(" "))throw new Error("FullName cannot have leading, trailing, or multiple consecutive spaces");return t.body.name=e,!0},X=[h("username").custom(function(){var e=m(p().m(function e(r,t){var n;return p().w(function(e){for(;;)switch(e.n){case 0:return n=t.req,e.n=1,H(r,{req:n},!0);case 1:return e.a(2,e.v)}},e)}));return function(r,t){return e.apply(this,arguments)}}()),h("email").custom(function(){var e=m(p().m(function e(r,t){var n;return p().w(function(e){for(;;)switch(e.n){case 0:return n=t.req,e.n=1,Q(r,{req:n},!0);case 1:return e.a(2,e.v)}},e)}));return function(r,t){return e.apply(this,arguments)}}()),h("password").custom(function(e,r){return function(e,r){r.req;var t=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(t&&(!e||""===e.trim()))throw new Error("Password is required");if(!t&&null==e)return!0;if(""===e.trim())throw new Error("Password cannot be empty");if(e.length<8)throw new Error("Password must be at least 8 characters long");if(e.length>128)throw new Error("Password cannot exceed 128 characters");if(!/(?=.*[a-z])/.test(e))throw new Error("Password must contain at least one lowercase letter");if(!/(?=.*[A-Z])/.test(e))throw new Error("Password must contain at least one uppercase letter");if(!/(?=.*\d)/.test(e))throw new Error("Password must contain at least one number");if(!/(?=.*[@$!%*?&])/.test(e))throw new Error("Password must contain at least one special character (@$!%*?&)");return!0}(e,{req:r.req},!0)}),h("confirmPassword").custom(function(e,r){var t=r.req;if(!e||""===e.trim())throw new Error("Please confirm your password");if(e!==t.body.password)throw new Error("Passwords do not match");return!0}),h("name").custom(function(e,r){var t=r.req;return Z(e,{req:t},!0)}),h("role").custom(function(e,r){return function(e,r){var t=r.req;if(null==e||""===e)return arguments.length>2&&void 0!==arguments[2]&&arguments[2]&&(t.body.role="admin"),!0;if(""===e.trim())throw new Error("Role cannot be empty");if(e=e.trim(),!["admin","SuperAdmin"].includes(e))throw new Error("Role must be either admin or SuperAdmin");return t.body.role=e,!0}(e,{req:r.req},!1)}),x],ee=[h("username").custom(function(){var e=m(p().m(function e(r,t){var n;return p().w(function(e){for(;;)switch(e.n){case 0:return n=t.req,e.n=1,H(r,{req:n},!1,n.params.id);case 1:return e.a(2,e.v)}},e)}));return function(r,t){return e.apply(this,arguments)}}()),h("email").custom(function(){var e=m(p().m(function e(r,t){var n;return p().w(function(e){for(;;)switch(e.n){case 0:return n=t.req,e.n=1,Q(r,{req:n},!1,n.params.id);case 1:return e.a(2,e.v)}},e)}));return function(r,t){return e.apply(this,arguments)}}()),h("name").custom(function(e,r){var t=r.req;return Z(e,{req:t},!1)}),x],re=[h("isActive").custom(function(e,r){var t=r.req;if(null==e)throw new Error("isActive field is required");if("boolean"!=typeof e){if("true"===e||!0===e)return t.body.isActive=!0,!0;if("false"===e||!1===e)return t.body.isActive=!1,!0;throw new Error("isActive must be true or false")}return!0}),x],te=[v("page").custom(function(e){if(void 0!==e){var r=parseInt(e);if(isNaN(r)||r<1)throw new Error("Page must be a positive integer")}return!0}),v("limit").custom(function(e){if(void 0!==e){var r=parseInt(e);if(isNaN(r)||r<1||r>10)throw new Error("Limit must be between 1 and 10")}return!0}),v("isActive").custom(function(e){if(void 0!==e&&"true"!==e&&"false"!==e)throw new Error("isActive must be true or false");return!0}),v("search").custom(function(e,r){var t=r.req;if(void 0!==e){if((e=e.trim()).length<1||e.length>100)throw new Error("Search term must be between 1 and 100 characters");t.query.search=e}return!0}),x],ne=[M].concat(X),oe=[M].concat(C,ee),ae=[].concat(te),ie=[].concat(C),se=[M].concat(C,re),ce=[b("id").custom(function(e,r){if(r.req,!e||""===e.trim())throw new Error("Property ID is required");if(!/^[0-9a-fA-F]{24}$/.test(e))throw new Error("Invalid property ID format");return!0}),x],ue=[h("rejectionReason").custom(function(e,r){var t=r.req;if(!e||""===e.trim())throw new Error("Rejection reason is required");if((e=e.trim()).length<10)throw new Error("Rejection reason must be at least 10 characters long");if(e.length>500)throw new Error("Rejection reason must not exceed 500 characters");return t.body.rejectionReason=e,!0}),x];e.exports={handleValidationErrors:x,loginValidation:L,changePasswordValidation:$,createPropertyWithImagesValidation:z,createPropertyWithoutImagesValidation:W,updatePropertyValidation:Y,propertyQueryValidation:K,singlePropertyValidation:J,createUserValidation:ne,updateUserValidation:oe,updateUserStatusValidation:se,userQueryValidation:ae,singleUserValidation:ie,parseFormDataOnly:G,parsePropertyDataFromFormData:function(e,r,t){if(e.body.propertyData)try{var n=JSON.parse(e.body.propertyData);Object.assign(e.body,n),delete e.body.propertyData}catch(e){return r.status(400).json({success:!1,error:"Invalid property data format"})}else console.log("â„¹ï¸ No propertyData field found, using req.body directly");t()},parseEnhancedFormData:function(e,r,t){if(e.body.propertyData)try{var i=JSON.parse(e.body.propertyData);Object.assign(e.body,i),delete e.body.propertyData}catch(e){return r.status(400).json({success:!1,error:"Invalid property data format"})}else{console.log("ℹ️ Parsing individual form fields"),console.log("Raw req.body keys:",Object.keys(e.body)),console.log("Raw req.files:",e.files?e.files.length:0);var s=function(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?o(Object(t),!0).forEach(function(r){a(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})}return e}({},e.body);e.body["location[address]"]&&(s.location={address:e.body["location[address]"],emirate:e.body["location[emirate]"],area:e.body["location[area]"],country:e.body["location[country]"],neighborhood:e.body["location[neighborhood]"]||""},Object.keys(e.body).forEach(function(e){e.startsWith("location[")&&delete s[e]}));var c={},u=!1;Object.keys(e.body).forEach(function(r){if(r.startsWith("details[")){u=!0;var t=r.match(/details\[([^\]]+)\](?:\[([^\]]+)\])?/);if(t){var o=n(t,3),a=o[1],i=o[2];i?(c[a]||(c[a]={}),c[a][i]=e.body[r]):c[a]=e.body[r]}delete s[r]}}),u&&(s.details=c);var l=[];Object.keys(e.body).forEach(function(r){if(r.startsWith("amenities[")){var t=parseInt(r.match(/amenities\[(\d+)\]/)[1]);l[t]=e.body[r],delete s[r]}}),l.length>0&&(s.amenities=l.filter(Boolean));var p=[];if(e.body.imageMetadata)try{"string"==typeof e.body.imageMetadata?p=JSON.parse(e.body.imageMetadata):Array.isArray(e.body.imageMetadata)&&(p=e.body.imageMetadata),delete s.imageMetadata}catch(e){console.error("Failed to parse imageMetadata JSON:",e)}Object.keys(e.body).forEach(function(r){if(r.startsWith("imageMetadata[")){var t=r.match(/imageMetadata\[(\d+)\]\[([^\]]+)\]/);if(t){var o=n(t,3),a=o[1],i=o[2],c=parseInt(a);p[c]||(p[c]={}),p[c][i]=e.body[r]}delete s[r]}}),p.length>0&&(e.imageMetadata=p.filter(Boolean)),e.body=s,console.log("Final parsed body:",JSON.stringify(e.body,null,2)),console.log("Image metadata:",e.imageMetadata)}t()},validatePropertyId:ce,validateRejection:ue}},572:e=>{"use strict";e.exports=require("nodemailer")},577:e=>{"use strict";e.exports=require("cors")},591:e=>{"use strict";e.exports=require("slugify")},604:(e,r,t)=>{var n=t(252).Router(),o=t(357),a=o.login,i=o.changePassword,s=t(567),c=s.loginValidation,u=s.changePasswordValidation,l=t(226).authWithPassword;n.post("/login",c,a),n.put("/change-password",l,u,i),e.exports=n},729:e=>{"use strict";e.exports=require("bcryptjs")},780:(e,r,t)=>{var n=t(252).Router(),o=t(912),a=o.sendContactEmail,i=o.sendInstantValuationEmail,s=o.sendPropertyInquiryEmail;n.post("/contact",a),n.post("/property-inquiry",s),n.post("/instant-valuation",i),e.exports=n},818:e=>{"use strict";e.exports=require("dotenv")},829:e=>{"use strict";e.exports=require("jsonwebtoken")},833:(e,r,t)=>{function n(){var e,r,t="function"==typeof Symbol?Symbol:{},a=t.iterator||"@@iterator",i=t.toStringTag||"@@toStringTag";function s(t,n,a,i){var s=n&&n.prototype instanceof u?n:u,l=Object.create(s.prototype);return o(l,"_invoke",function(t,n,o){var a,i,s,u=0,l=o||[],p=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(r,t){return a=r,i=0,s=e,d.n=t,c}};function f(t,n){for(i=t,s=n,r=0;!p&&u&&!o&&r<l.length;r++){var o,a=l[r],f=d.p,m=a[2];t>3?(o=m===n)&&(s=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=t<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=t<3||a[0]>n||n>m)&&(a[4]=t,a[5]=n,d.n=m,i=0))}if(o||t>1)return c;throw p=!0,n}return function(o,l,m){if(u>1)throw TypeError("Generator is already running");for(p&&1===l&&f(l,m),i=l,s=m;(r=i<2?e:s)||!p;){a||(i?i<3?(i>1&&(d.n=-1),f(i,s)):d.n=s:d.v=s);try{if(u=2,a){if(i||(o="next"),r=a[o]){if(!(r=r.call(a,s)))throw TypeError("iterator result is not an object");if(!r.done)return r;s=r.value,i<2&&(i=0)}else 1===i&&(r=a.return)&&r.call(a),i<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((r=(p=d.n<0)?s:t.call(n,d))!==c)break}catch(r){a=e,i=1,s=r}finally{u=1}}return{value:r,done:p}}}(t,a,i),!0),l}var c={};function u(){}function l(){}function p(){}r=Object.getPrototypeOf;var d=[][a]?r(r([][a]())):(o(r={},a,function(){return this}),r),f=p.prototype=u.prototype=Object.create(d);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,o(e,i,"GeneratorFunction")),e.prototype=Object.create(f),e}return l.prototype=p,o(f,"constructor",p),o(p,"constructor",l),l.displayName="GeneratorFunction",o(p,i,"GeneratorFunction"),o(f),o(f,i,"Generator"),o(f,a,function(){return this}),o(f,"toString",function(){return"[object Generator]"}),(n=function(){return{w:s,m}})()}function o(e,r,t,n){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}o=function(e,r,t,n){function i(r,t){o(e,r,function(e){return this._invoke(r,t,e)})}r?a?a(e,r,{value:t,enumerable:!n,configurable:!n,writable:!n}):e[r]=t:(i("next",0),i("throw",1),i("return",2))},o(e,r,t,n)}function a(e,r,t,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void t(e)}s.done?r(c):Promise.resolve(c).then(n,o)}function i(e){return function(){var r=this,t=arguments;return new Promise(function(n,o){var i=e.apply(r,t);function s(e){a(i,n,o,s,c,"next",e)}function c(e){a(i,n,o,s,c,"throw",e)}s(void 0)})}}var s=t(187),c=(t(217),function(){var e=i(n().m(function e(r,t){var o,a,i,c,u,l,p,d,f,m,y,g,h,v,b,w,E,S,j;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,o=r.query,a=o.page,i=void 0===a?1:a,c=o.limit,u=void 0===c?10:c,l=o.sortBy,p=void 0===l?"createdAt":l,d=o.sortOrder,f=void 0===d?"desc":d,m=o.propertyType,y=o.emirate,g=o.createdBy,h={approvalStatus:"pending"},m&&(h.propertyType=m),y&&(h["location.emirate"]=y),g&&(h.createdBy=g),v=(parseInt(i)-1)*parseInt(u),(b={})[p]="desc"===f?-1:1,e.n=1,s.find(h).populate("createdBy","name email username").sort(b).skip(v).limit(parseInt(u));case 1:return w=e.v,e.n=2,s.countDocuments(h);case 2:E=e.v,S=Math.ceil(E/parseInt(u)),t.status(200).json({success:!0,data:{properties:w,pagination:{currentPage:parseInt(i),totalPages:S,totalProperties:E,hasNextPage:parseInt(i)<S,hasPrevPage:parseInt(i)>1}}}),e.n=4;break;case 3:e.p=3,j=e.v,console.error("Error fetching pending properties:",j),t.status(500).json({success:!1,error:"Failed to fetch pending properties"});case 4:return e.a(2)}},e,null,[[0,3]])}));return function(r,t){return e.apply(this,arguments)}}()),u=function(){var e=i(n().m(function e(r,t){var o,a,i;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,o=r.params.id,r.body.notes,e.n=1,s.findById(o).populate("createdBy","name email");case 1:if(a=e.v){e.n=2;break}return e.a(2,t.status(404).json({success:!1,error:"Property not found"}));case 2:if("pending"===a.approvalStatus){e.n=3;break}return e.a(2,t.status(400).json({success:!1,error:"Property is already ".concat(a.approvalStatus)}));case 3:return a.approvalStatus="approved",a.updatedBy=r.user.id,a.updatedAt=new Date,a.rejectionReason=void 0,e.n=4,a.save();case 4:t.status(200).json({success:!0,message:'Property "'.concat(a.title,'" has been approved'),data:{property:{id:a._id,title:a.title,approvalStatus:a.approvalStatus,updatedAt:a.updatedAt,updatedBy:a.updatedBy,createdBy:a.createdBy}}}),e.n=6;break;case 5:e.p=5,i=e.v,console.error("Error approving property:",i),t.status(500).json({success:!1,error:"Failed to approve property"});case 6:return e.a(2)}},e,null,[[0,5]])}));return function(r,t){return e.apply(this,arguments)}}(),l=function(){var e=i(n().m(function e(r,t){var o,a,i,c;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,o=r.params.id,(a=r.body.rejectionReason)&&0!==a.trim().length){e.n=1;break}return e.a(2,t.status(400).json({success:!1,error:"Rejection reason is required"}));case 1:return e.n=2,s.findById(o).populate("createdBy","name email");case 2:if(i=e.v){e.n=3;break}return e.a(2,t.status(404).json({success:!1,error:"Property not found"}));case 3:if("pending"===i.approvalStatus){e.n=4;break}return e.a(2,t.status(400).json({success:!1,error:"Property is already ".concat(i.approvalStatus)}));case 4:return i.approvalStatus="rejected",i.updatedBy=r.user.id,i.updatedAt=new Date,i.rejectionReason=a.trim(),e.n=5,i.save();case 5:t.status(200).json({success:!0,message:'Property "'.concat(i.title,'" has been rejected'),data:{property:{id:i._id,title:i.title,approvalStatus:i.approvalStatus,rejectionReason:i.rejectionReason,updatedAt:i.updatedAt,updatedBy:i.updatedBy,createdBy:i.createdBy}}}),e.n=7;break;case 6:e.p=6,c=e.v,console.error("Error rejecting property:",c),t.status(500).json({success:!1,error:"Failed to reject property"});case 7:return e.a(2)}},e,null,[[0,6]])}));return function(r,t){return e.apply(this,arguments)}}(),p=function(){var e=i(n().m(function e(r,t){var o,a,i,c,u;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,s.aggregate([{$group:{_id:"$approvalStatus",count:{$sum:1}}}]);case 1:return o=e.v,a={pending:0,approved:0,rejected:0},o.forEach(function(e){a[e._id]=e.count}),(i=new Date).setDate(i.getDate()-30),e.n=2,s.find({updatedAt:{$gte:i},approvalStatus:{$in:["approved","rejected"]}}).populate("createdBy","name").populate("updatedBy","name").sort({updatedAt:-1}).limit(10).select("title approvalStatus updatedAt rejectionReason createdBy updatedBy");case 2:c=e.v,t.status(200).json({success:!0,data:{stats:a,total:a.pending+a.approved+a.rejected,recentActivity:c}}),e.n=4;break;case 3:e.p=3,u=e.v,console.error("Error fetching approval stats:",u),t.status(500).json({success:!1,error:"Failed to fetch approval statistics"});case 4:return e.a(2)}},e,null,[[0,3]])}));return function(r,t){return e.apply(this,arguments)}}();e.exports={getPendingProperties:c,approveProperty:u,rejectProperty:l,getApprovalStats:p}},896:e=>{"use strict";e.exports=require("fs")},902:(e,r,t)=>{function n(){var e,r,t="function"==typeof Symbol?Symbol:{},a=t.iterator||"@@iterator",i=t.toStringTag||"@@toStringTag";function s(t,n,a,i){var s=n&&n.prototype instanceof u?n:u,l=Object.create(s.prototype);return o(l,"_invoke",function(t,n,o){var a,i,s,u=0,l=o||[],p=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(r,t){return a=r,i=0,s=e,d.n=t,c}};function f(t,n){for(i=t,s=n,r=0;!p&&u&&!o&&r<l.length;r++){var o,a=l[r],f=d.p,m=a[2];t>3?(o=m===n)&&(s=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=t<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=t<3||a[0]>n||n>m)&&(a[4]=t,a[5]=n,d.n=m,i=0))}if(o||t>1)return c;throw p=!0,n}return function(o,l,m){if(u>1)throw TypeError("Generator is already running");for(p&&1===l&&f(l,m),i=l,s=m;(r=i<2?e:s)||!p;){a||(i?i<3?(i>1&&(d.n=-1),f(i,s)):d.n=s:d.v=s);try{if(u=2,a){if(i||(o="next"),r=a[o]){if(!(r=r.call(a,s)))throw TypeError("iterator result is not an object");if(!r.done)return r;s=r.value,i<2&&(i=0)}else 1===i&&(r=a.return)&&r.call(a),i<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((r=(p=d.n<0)?s:t.call(n,d))!==c)break}catch(r){a=e,i=1,s=r}finally{u=1}}return{value:r,done:p}}}(t,a,i),!0),l}var c={};function u(){}function l(){}function p(){}r=Object.getPrototypeOf;var d=[][a]?r(r([][a]())):(o(r={},a,function(){return this}),r),f=p.prototype=u.prototype=Object.create(d);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,o(e,i,"GeneratorFunction")),e.prototype=Object.create(f),e}return l.prototype=p,o(f,"constructor",p),o(p,"constructor",l),l.displayName="GeneratorFunction",o(p,i,"GeneratorFunction"),o(f),o(f,i,"Generator"),o(f,a,function(){return this}),o(f,"toString",function(){return"[object Generator]"}),(n=function(){return{w:s,m}})()}function o(e,r,t,n){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}o=function(e,r,t,n){function i(r,t){o(e,r,function(e){return this._invoke(r,t,e)})}r?a?a(e,r,{value:t,enumerable:!n,configurable:!n,writable:!n}):e[r]=t:(i("next",0),i("throw",1),i("return",2))},o(e,r,t,n)}function a(e,r,t,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void t(e)}s.done?r(c):Promise.resolve(c).then(n,o)}var i=t(436),s=i.rolePermissions,c=i.buildPropertyQuery,u=i.buildUserQuery;e.exports={checkPermission:function(e,r){return function(){var t,o=(t=n().m(function t(o,a,i){var l,p,d,f,m,y,g;return n().w(function(t){for(;;)switch(t.p=t.n){case 0:if(t.p=0,p=(null===(l=o.user)||void 0===l?void 0:l.role)||"visitor",(d=s[p])&&d[e]){t.n=1;break}return t.a(2,a.status(403).json({success:!1,error:"Access denied - Resource not accessible"}));case 1:if(f=d[e][r]){t.n=2;break}return t.a(2,a.status(403).json({success:!1,error:"Access denied - Action not permitted"}));case 2:if(o.userRole=p,o.permissionLevel=f,"properties"===e&&"Read"===r?o.queryFilters=c(o.user):"users"===e&&"Read"===r&&(o.queryFilters=u(o.user)),"own"!==f){t.n=3;break}if(o.requireOwnership=!0,"users"!==e){t.n=3;break}if(m=o.params.id,y=o.user.id.toString(),!m||m===y){t.n=3;break}return t.a(2,a.status(403).json({success:!1,error:"Access denied - You can only access your own profile"}));case 3:i(),t.n=5;break;case 4:return t.p=4,g=t.v,console.error("Permission check failed:",g),t.a(2,a.status(500).json({success:!1,error:"Permission check failed"}));case 5:return t.a(2)}},t,null,[[0,4]])}),function(){var e=this,r=arguments;return new Promise(function(n,o){var i=t.apply(e,r);function s(e){a(i,n,o,s,c,"next",e)}function c(e){a(i,n,o,s,c,"throw",e)}s(void 0)})});return function(e,r,t){return o.apply(this,arguments)}}()}}},912:(e,r,t)=>{function n(){var e,r,t="function"==typeof Symbol?Symbol:{},a=t.iterator||"@@iterator",i=t.toStringTag||"@@toStringTag";function s(t,n,a,i){var s=n&&n.prototype instanceof u?n:u,l=Object.create(s.prototype);return o(l,"_invoke",function(t,n,o){var a,i,s,u=0,l=o||[],p=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(r,t){return a=r,i=0,s=e,d.n=t,c}};function f(t,n){for(i=t,s=n,r=0;!p&&u&&!o&&r<l.length;r++){var o,a=l[r],f=d.p,m=a[2];t>3?(o=m===n)&&(s=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=t<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=t<3||a[0]>n||n>m)&&(a[4]=t,a[5]=n,d.n=m,i=0))}if(o||t>1)return c;throw p=!0,n}return function(o,l,m){if(u>1)throw TypeError("Generator is already running");for(p&&1===l&&f(l,m),i=l,s=m;(r=i<2?e:s)||!p;){a||(i?i<3?(i>1&&(d.n=-1),f(i,s)):d.n=s:d.v=s);try{if(u=2,a){if(i||(o="next"),r=a[o]){if(!(r=r.call(a,s)))throw TypeError("iterator result is not an object");if(!r.done)return r;s=r.value,i<2&&(i=0)}else 1===i&&(r=a.return)&&r.call(a),i<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((r=(p=d.n<0)?s:t.call(n,d))!==c)break}catch(r){a=e,i=1,s=r}finally{u=1}}return{value:r,done:p}}}(t,a,i),!0),l}var c={};function u(){}function l(){}function p(){}r=Object.getPrototypeOf;var d=[][a]?r(r([][a]())):(o(r={},a,function(){return this}),r),f=p.prototype=u.prototype=Object.create(d);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,o(e,i,"GeneratorFunction")),e.prototype=Object.create(f),e}return l.prototype=p,o(f,"constructor",p),o(p,"constructor",l),l.displayName="GeneratorFunction",o(p,i,"GeneratorFunction"),o(f),o(f,i,"Generator"),o(f,a,function(){return this}),o(f,"toString",function(){return"[object Generator]"}),(n=function(){return{w:s,m}})()}function o(e,r,t,n){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}o=function(e,r,t,n){function i(r,t){o(e,r,function(e){return this._invoke(r,t,e)})}r?a?a(e,r,{value:t,enumerable:!n,configurable:!n,writable:!n}):e[r]=t:(i("next",0),i("throw",1),i("return",2))},o(e,r,t,n)}function a(e,r,t,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void t(e)}s.done?r(c):Promise.resolve(c).then(n,o)}function i(e){return function(){var r=this,t=arguments;return new Promise(function(n,o){var i=e.apply(r,t);function s(e){a(i,n,o,s,c,"next",e)}function c(e){a(i,n,o,s,c,"throw",e)}s(void 0)})}}var s=t(528).createTransporter,c=function(){var e=i(n().m(function e(r,t){var o,a,i,c,u,l,p,d,f,m,y,g,h,v,b,w,E,S;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,o=r.body,a=o.firstName,i=o.lastName,c=o.email,u=o.phone,l=o.propertyStatus,p=o.userInfo,d=o.maxPrice,f=o.minSize,m=o.bedrooms,y=o.bathrooms,g=o.message,h=o.recipient,v=void 0===h?process.env.EMAIL_USER:h,a&&i&&c&&g){e.n=1;break}return e.a(2,t.status(400).json({success:!1,message:"Please provide name, email and message"}));case 1:return b=s(),w={from:'"EarlyBirds Properties" <'.concat(process.env.EMAIL_USER,">"),to:v,subject:"Contact Form: ".concat(l||"General"," Inquiry from ").concat(a," ").concat(i),html:"\n        <h2>Contact Form Submission</h2>\n        <p><strong>Name:</strong> ".concat(a," ").concat(i,"</p>\n        <p><strong>Email:</strong> ").concat(c,"</p>\n        ").concat(u?"<p><strong>Phone:</strong> ".concat(u,"</p>"):"","\n        ").concat(l?"<p><strong>Property Status:</strong> ".concat(l,"</p>"):"","\n        ").concat(p?"<p><strong>User Info:</strong> ".concat(p,"</p>"):"","\n        ").concat(d?"<p><strong>Max Price:</strong> ".concat(d,"</p>"):"","\n        ").concat(f?"<p><strong>Min Size (Sq Ft):</strong> ".concat(f,"</p>"):"","\n        ").concat(m?"<p><strong>Bedrooms:</strong> ".concat(m,"</p>"):"","\n        ").concat(y?"<p><strong>Bathrooms:</strong> ".concat(y,"</p>"):"","\n        <p><strong>Message:</strong> ").concat(g,"</p>\n      "),replyTo:c},e.n=2,b.sendMail(w);case 2:E=e.v,t.status(200).json({success:!0,message:"Email sent successfully",messageId:E.messageId}),e.n=4;break;case 3:e.p=3,S=e.v,console.error("Error sending email:",S),t.status(500).json({success:!1,message:"Failed to send email",error:S.message});case 4:return e.a(2)}},e,null,[[0,3]])}));return function(r,t){return e.apply(this,arguments)}}(),u=function(){var e=i(n().m(function e(r,t){var o,a,i,c,u,l,p,d,f,m,y,g,h,v;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,o=r.body,a=o.name,i=o.email,c=o.phone,u=o.message,l=o.propertyId,p=o.propertyTitle,d=o.agent,o.type,f=o.recipient,m=void 0===f?process.env.EMAIL_USER:f,a&&i&&c&&u){e.n=1;break}return e.a(2,t.status(400).json({success:!1,message:"Please provide name, email, phone and message"}));case 1:if(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i)){e.n=2;break}return e.a(2,t.status(400).json({success:!1,message:"Invalid email format"}));case 2:return y=s(),g={from:'"EarlyBirds Properties" <'.concat(process.env.EMAIL_USER,">"),to:m,subject:"New Property Inquiry - ".concat(p||"Property"),html:'\n        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">\n          <h2 style="color: #bd8c31;">New Property Inquiry</h2>\n          <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">\n            <h3>Contact Information:</h3>\n            <p><strong>Name:</strong> '.concat(a,"</p>\n            <p><strong>Email:</strong> ").concat(i,"</p>\n            <p><strong>Phone:</strong> ").concat(c,'</p>\n          </div>\n          <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">\n            <h3>Property Details:</h3>\n            <p><strong>Property ID:</strong> ').concat(l||"N/A","</p>\n            <p><strong>Property Title:</strong> ").concat(p||"N/A","</p>\n            <p><strong>Agent:</strong> ").concat(d,'</p>\n          </div>\n          <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">\n            <h3>Message:</h3>\n            <p>').concat(u,'</p>\n          </div>\n          <p style="color: #666; font-size: 12px;">This inquiry was submitted through the EarlyBirds Properties website.</p>\n        </div>\n      '),replyTo:i},h={from:'"EarlyBirds Properties" <'.concat(process.env.EMAIL_USER,">"),to:i,subject:"Thank you for your property inquiry - EarlyBirds Properties",html:'\n        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">\n          <h2 style="color: #bd8c31;">Thank you for your inquiry!</h2>\n          <p>Dear '.concat(a,',</p>\n          <p>Thank you for your interest in our property. We have received your inquiry and our team will get back to you within 24 hours.</p>\n          \n          <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">\n            <h3>Your Inquiry Details:</h3>\n            <p><strong>Property:</strong> ').concat(p||"Property","</p>\n            <p><strong>Agent:</strong> ").concat(d,"</p>\n            <p><strong>Your Message:</strong> ").concat(u,'</p>\n          </div>\n          \n          <p>If you have any urgent questions, please don\'t hesitate to contact us directly:</p>\n          <p><strong>Phone:</strong> +971 50 123 4567</p>\n          <p><strong>Email:</strong> info@earlybirds.ae</p>\n          \n          <p>Best regards,<br>EarlyBirds Properties Team</p>\n          \n          <p style="color: #666; font-size: 12px;">This is an automated confirmation email. Please do not reply to this email.</p>\n        </div>\n      ')},e.n=3,Promise.all([y.sendMail(g),y.sendMail(h)]);case 3:t.status(200).json({success:!0,message:"Property inquiry sent successfully"}),e.n=5;break;case 4:e.p=4,v=e.v,console.error("Error sending property inquiry email:",v),t.status(500).json({success:!1,message:"Failed to send property inquiry",error:v.message});case 5:return e.a(2)}},e,null,[[0,4]])}));return function(r,t){return e.apply(this,arguments)}}(),l=function(){var e=i(n().m(function e(r,t){var o,a,i,c,u,l,p,d,f,m,y,g,h,v,b,w,E;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,o=r.body,a=o.name,i=o.email,c=o.phone,u=o.propertyStatus,l=o.propertyType,p=o.emirate,d=o.beds,f=o.size,m=o.price,y=o.images,g=o.recipient,h=void 0===g?process.env.EMAIL_USER:g,a&&i&&c&&u&&l&&p){e.n=1;break}return e.a(2,t.status(400).json({success:!1,message:"Missing required fields"}));case 1:return v=s(),b={from:'"EarlyBirds Properties" <'.concat(process.env.EMAIL_USER,">"),to:h,subject:"Instant Valuation Request: ".concat(l," in ").concat(p),html:"\n        <h2>Instant Valuation Request</h2>\n        <p><strong>Name:</strong> ".concat(a,"</p>\n        <p><strong>Email:</strong> ").concat(i,"</p>\n        <p><strong>Phone:</strong> ").concat(c,"</p>\n        <p><strong>Property Status:</strong> ").concat(u,"</p>\n        <p><strong>Property Type:</strong> ").concat(l,"</p>\n        <p><strong>Emirate:</strong> ").concat(p,"</p>\n        ").concat(d?"<p><strong>Bedrooms:</strong> ".concat(d,"</p>"):"","\n        ").concat(f?"<p><strong>Size (Sq Ft):</strong> ".concat(f,"</p>"):"","\n        ").concat(m?"<p><strong>Expected Price:</strong> ".concat(m,"</p>"):"","\n        ").concat(y&&y.length>0?"\n          <p><strong>Images:</strong></p>\n          <ul>\n            ".concat(y.map(function(e){return'<li><a href="'.concat(e.url,'" target="_blank">').concat(e.originalName||"Property Image","</a></li>")}).join(""),"\n          </ul>\n        "):"<p><strong>Images:</strong> No images uploaded</p>","\n      "),replyTo:i},e.n=2,v.sendMail(b);case 2:w=e.v,t.status(200).json({success:!0,message:"Valuation request sent successfully",messageId:w.messageId}),e.n=4;break;case 3:e.p=3,E=e.v,console.error("Error sending valuation email:",E),t.status(500).json({success:!1,message:"Failed to send valuation request",error:E.message});case 4:return e.a(2)}},e,null,[[0,3]])}));return function(r,t){return e.apply(this,arguments)}}();e.exports={sendContactEmail:c,sendInstantValuationEmail:l,sendPropertyInquiryEmail:u}},928:e=>{"use strict";e.exports=require("path")},962:e=>{e.exports=function(e,r,t,n){if(console.error(e.stack),"ValidationError"===e.name){var o=Object.values(e.errors).map(function(e){return e.message});return t.status(400).json({error:o.join(", ")})}if(11e3===e.code){var a=Object.keys(e.keyValue)[0];return t.status(400).json({error:"".concat(a," already exists")})}return"JsonWebTokenError"===e.name?t.status(401).json({error:"Invalid token"}):"TokenExpiredError"===e.name?t.status(401).json({error:"Token expired"}):void t.status(500).json({error:"Internal server error"})}},975:e=>{"use strict";e.exports=require("express-validator")},989:e=>{e.exports={PROPERTY_TYPES:["apartment","villa","townhouse","penthouse","studio","office"],EMIRATES:["Dubai","Abu Dhabi","Sharjah","Ajman","Ras Al Khaimah","Fujairah","Umm Al Quwain"],LISTING_TYPES:["sale","rent","off plan"],PROPERTY_STATUS:["available","sold","rented","pending","draft","archived"],APPROVAL_STATUS:["pending","approved","rejected","not_applicable"],AREA_UNITS:["sqft","sqm"],PARKING_TYPES:["covered","open","garage","street"],PRICE_TYPES:["total","per_sqft","per_sqm"],COUNTRIES:["UAE"],CURRENCIES:["AED"],EMIRATE_AREA_MAP:{Dubai:["Downtown Dubai","Dubai Marina","Jumeirah Beach Residence (JBR)","Palm Jumeirah","Business Bay","DIFC","Dubai Hills Estate","Arabian Ranches","Jumeirah Village Circle (JVC)","Dubai Sports City","Motor City","The Greens","Emirates Hills","Jumeirah","Bur Dubai","Deira","Al Barsha","Dubai Investment Park (DIP)","International City","Discovery Gardens","Mirdif","Festival City","Silicon Oasis","Dubai South","Al Furjan","Damac Hills","Town Square","Dubai Land","Al Mizhar","Al Warqa"],"Abu Dhabi":["Abu Dhabi City","Al Reem Island","Saadiyat Island","Yas Island","Al Reef","Khalifa City","Mohammed Bin Zayed City","Al Shamkha","Al Rahba","Masdar City","Corniche Area","Tourist Club Area","Electra Street","Hamdan Street","Al Bateen","Al Mushrif","Al Karamah","Al Manhal","Al Khalidiyah","Al Markaziyah"],Sharjah:["Sharjah City","Al Majaz","Al Qasba","Al Nahda","Muweilah","Al Warqa","University City","Al Taawun","Al Qadisiya","Al Fisht"],Ajman:["Ajman City","Al Nuaimiya","Al Rashidiya","Al Jurf","Al Hamidiyah"],"Ras Al Khaimah":["RAK City","Al Hamra","Mina Al Arab","Al Marjan Island","Al Rams","Al Jazirah Al Hamra"],Fujairah:["Fujairah City","Dibba Al-Fujairah","Kalba","Khor Fakkan","Al Bithnah"],"Umm Al Quwain":["UAQ City","Al Salamah","Falaj Al Mualla"]},PROPERTY_TYPE_AMENITIES_MAP:{apartment:["Air Conditioning","Central Heating","Built-in Wardrobes","Balcony","City View","Sea View","Marina View","High Floor","Elevator","Swimming Pool","Gym","Security","24/7 Security","CCTV","Concierge","Parking","Covered Parking","Internet Ready","Cable TV Ready","Intercom","Maintenance","Cleaning Service","Pets Allowed","Furnished","Semi Furnished","Unfurnished"],villa:["Private Pool","Private Garden","Garage","Maid Room","Driver Room","Study Room","Walk-in Closet","Multiple Living Areas","Formal Dining","Family Room","Home Office","Storage Room","Laundry Room","BBQ Area","Outdoor Kitchen","Jacuzzi","Fireplace","High Ceilings","Marble Floors","Wooden Floors","Smart Home","Solar Panels","Generator Backup","Security System","CCTV","Landscaped Garden","Tree-lined Street","Gated Community","Beach Access"],townhouse:["Private Garden","Garage","Maid Room","Study Room","Storage Room","Laundry Room","Multiple Levels","Terrace","Rooftop Access","Modern Kitchen","Built-in Wardrobes","Walk-in Closet","Family Room","Dining Room","Home Office","BBQ Area","Covered Parking","Air Conditioning","Central Heating","Community Pool","Community Gym","Playground","Security","Gated Community","Maintenance","Landscaping"],penthouse:["Private Pool","Private Terrace","Rooftop Access","Panoramic Views","Sky Lounge","Private Elevator","High-end Finishes","Marble Floors","Floor-to-ceiling Windows","Smart Home System","Home Automation","Premium Kitchen","Wine Cellar","Walk-in Closet","Master Suite","Jacuzzi","Steam Room","Home Theater","Study Room","Maid Room","Driver Room","Laundry Room","Storage Room","Private Garage","Concierge Service","24/7 Security","Valet Parking"],studio:["Air Conditioning","Built-in Wardrobes","Balcony","City View","Sea View","High Floor","Modern Kitchen","Marble Floors","Wooden Floors","Swimming Pool","Gym","Security","Elevator","Parking","Covered Parking","Internet Ready","Cable TV Ready","Intercom","Maintenance","Furnished","Semi Furnished","Unfurnished","Compact Design","Efficient Layout"],office:["Prime Location","High Visibility","Street Frontage","Air Conditioning","Central Heating","Elevator","High Speed Elevators","Reception Area","Lobby","Private Offices","Open Plan Layout","Meeting Rooms","Conference Room","Boardroom","Kitchen Facilities","Pantry","Bathroom Facilities","Prayer Room","Storage Space","Server Room","IT Infrastructure","High Speed Internet","Fiber Optic Ready","Phone Lines","Video Conferencing","Security System","24/7 Security","CCTV","Access Control","Fire Safety System","Sprinkler System","Backup Generator","UPS System","Disabled Access","After Hours Access","Maintenance Service","Cleaning Service","Concierge Service","Mail Service","Signage Rights","Building Directory","Public Transport Access","Metro Access","Bus Stop Nearby","Taxi Stand","Restaurant Nearby","Banking Services","Shopping Center Nearby","Hotel Nearby","Furnished","Semi Furnished","Unfurnished","Ready to Move","Shell and Core","Fitted Office","Grade A Building","LEED Certified","Green Building","Sustainable Design"]}}}},r={};function t(n){var o=r[n];if(void 0!==o)return o.exports;var a=r[n]={exports:{}};return e[n](a,a.exports,t),a.exports}function n(){var e,r,t="function"==typeof Symbol?Symbol:{},a=t.iterator||"@@iterator",i=t.toStringTag||"@@toStringTag";function s(t,n,a,i){var s=n&&n.prototype instanceof u?n:u,l=Object.create(s.prototype);return o(l,"_invoke",function(t,n,o){var a,i,s,u=0,l=o||[],p=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(r,t){return a=r,i=0,s=e,d.n=t,c}};function f(t,n){for(i=t,s=n,r=0;!p&&u&&!o&&r<l.length;r++){var o,a=l[r],f=d.p,m=a[2];t>3?(o=m===n)&&(s=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=t<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=t<3||a[0]>n||n>m)&&(a[4]=t,a[5]=n,d.n=m,i=0))}if(o||t>1)return c;throw p=!0,n}return function(o,l,m){if(u>1)throw TypeError("Generator is already running");for(p&&1===l&&f(l,m),i=l,s=m;(r=i<2?e:s)||!p;){a||(i?i<3?(i>1&&(d.n=-1),f(i,s)):d.n=s:d.v=s);try{if(u=2,a){if(i||(o="next"),r=a[o]){if(!(r=r.call(a,s)))throw TypeError("iterator result is not an object");if(!r.done)return r;s=r.value,i<2&&(i=0)}else 1===i&&(r=a.return)&&r.call(a),i<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((r=(p=d.n<0)?s:t.call(n,d))!==c)break}catch(r){a=e,i=1,s=r}finally{u=1}}return{value:r,done:p}}}(t,a,i),!0),l}var c={};function u(){}function l(){}function p(){}r=Object.getPrototypeOf;var d=[][a]?r(r([][a]())):(o(r={},a,function(){return this}),r),f=p.prototype=u.prototype=Object.create(d);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,o(e,i,"GeneratorFunction")),e.prototype=Object.create(f),e}return l.prototype=p,o(f,"constructor",p),o(p,"constructor",l),l.displayName="GeneratorFunction",o(p,i,"GeneratorFunction"),o(f),o(f,i,"Generator"),o(f,a,function(){return this}),o(f,"toString",function(){return"[object Generator]"}),(n=function(){return{w:s,m}})()}function o(e,r,t,n){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}o=function(e,r,t,n){function i(r,t){o(e,r,function(e){return this._invoke(r,t,e)})}r?a?a(e,r,{value:t,enumerable:!n,configurable:!n,writable:!n}):e[r]=t:(i("next",0),i("throw",1),i("return",2))},o(e,r,t,n)}function a(e,r,t,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void t(e)}s.done?r(c):Promise.resolve(c).then(n,o)}var i=t(252),s=t(577),c=t(525),u=t(174),l=t(928);t(818).config({path:"./backend/.env"});var p=t(531).connectDB,d=t(604),f=t(395),m=t(0),y=t(267),g=t(224),h=t(780),v=t(962),b=i();b.use(c());var w=[process.env.Admin_URL,process.env.User_URL,process.env.BASE_URL].filter(Boolean);console.log("🔧 CORS: Allowed origins:",w),b.use(s({origin:function(e,r){return e?w.includes(e)?r(null,!0):r(new Error("Not allowed by CORS. Origin: ".concat(e))):r(null,!0)},credentials:!0,optionsSuccessStatus:200})),b.use(i.json({limit:"20mb"})),b.use(i.urlencoded({extended:!0,limit:"20mb"})),b.use(u()),b.use("/uploads",i.static(l.join(__dirname,"uploads"))),b.use(function(e,r,t){console.log("🌐 Incoming request: ".concat(e.method," ").concat(e.originalUrl," - ").concat((new Date).toISOString())),t()}),b.get("/api",function(e,r){r.status(200).json({success:!0,message:"Real Estate API v1.0",version:"1.0.0",endpoints:{auth:"/api/auth",properties:"/api/properties"}})}),b.use("/api/auth",d),b.use("/api/properties",f),b.use("/api/property-approval",m),b.use("/api/upload",y),b.use("/api/users",g),b.use("/api/email",h),b.use(v),b.use("*",function(e,r){r.status(404).json({error:"Route not found"})});var E=process.env.PORT||3e3;!function(){var e,r=(e=n().m(function e(){var r;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,p();case 1:b.listen(E,function(){console.log("Server running on port ".concat(E))}),e.n=3;break;case 2:e.p=2,r=e.v,console.error("Failed to start server:",r),process.exit(1);case 3:return e.a(2)}},e,null,[[0,2]])}),function(){var r=this,t=arguments;return new Promise(function(n,o){var i=e.apply(r,t);function s(e){a(i,n,o,s,c,"next",e)}function c(e){a(i,n,o,s,c,"throw",e)}s(void 0)})});return function(){return r.apply(this,arguments)}}()()})();